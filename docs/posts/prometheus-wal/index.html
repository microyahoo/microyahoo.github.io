<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="æ¦‚è¿° #  WAL(Write-ahead logging, é¢„å†™æ—¥å¿—)æ˜¯å…³ç³»å‹æ•°æ®åº“ä¸­åˆ©ç”¨æ—¥å¿—æ¥å®ç°äº‹åŠ¡æ€§å’ŒæŒä¹…æ€§çš„ä¸€ç§æŠ€æœ¯ï¼Œå³åœ¨æŸä¸ªæ“ä½œä¹‹å‰å…ˆå°†è¿™ä¸ªäº‹æƒ…è®°å½•ä¸‹æ¥ï¼Œä»¥ä¾¿ä¹‹åå¯¹æ•°æ®è¿›è¡Œå›æ»šï¼Œé‡è¯•ç­‰æ“ä½œä¿è¯æ•°æ®çš„å¯é æ€§ã€‚
Prometheusä¸ºäº†é˜²æ­¢ä¸¢å¤±æš‚å­˜åœ¨å†…å­˜ä¸­çš„è¿˜æœªè¢«å†™å…¥ç£ç›˜çš„ç›‘æ§æ•°æ®ï¼Œå¼•å…¥äº†WALæœºåˆ¶ã€‚WALè¢«åˆ†å‰²æˆé»˜è®¤å¤§å°ä¸º128Mçš„æ–‡ä»¶æ®µï¼ˆsegmentï¼‰ï¼Œä¹‹å‰ç‰ˆæœ¬é»˜è®¤å¤§å°æ˜¯256Mï¼Œæ–‡ä»¶æ®µä»¥æ•°å­—å‘½åï¼Œé•¿åº¦ä¸º8ä½çš„æ•´å½¢ã€‚WALçš„å†™å…¥å•ä½æ˜¯é¡µï¼ˆpageï¼‰ï¼Œæ¯é¡µçš„å¤§å°ä¸º32KBï¼Œæ‰€ä»¥æ¯ä¸ªæ®µå¤§å°å¿…é¡»æ˜¯é¡µçš„å¤§å°çš„æ•´æ•°å€ã€‚æ¯ä¸ªæ–‡ä»¶æ®µéƒ½æœ‰ä¸€ä¸ªâ€œ==å·²ä½¿ç”¨çš„é¡µï¼Ÿ==â€å±æ€§æ¥æ ‡è¯†åœ¨è¯¥æ®µä¸­å·²ç»åˆ†é…çš„é¡µæ•°ç›®ï¼Œå¦‚æœWALä¸€æ¬¡æ€§å†™å…¥çš„é¡µæ•°è¶…è¿‡ä¸€ä¸ªæ®µçš„ç©ºé—²é¡µæ•°ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶æ®µæ¥ä¿å­˜è¿™äº›é¡µï¼Œä»è€Œç¡®ä¿ä¸€æ¬¡æ€§å†™å…¥çš„é¡µä¸ä¼šè·¨æ®µå­˜å‚¨ã€‚
const ( DefaultSegmentSize = 128 * 1024 * 1024 // 128 MB  pageSize = 32 * 1024 // 32KB  recordHeaderSize = 7 ) æœ¬æ–‡æ˜¯åœ¨prometheus tsdbéƒ¨åˆ†æºç é˜…è¯»ä¹‹wal.LogSeriesåŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•ï¼Œç”±äºtsdb/wal.goæ–‡ä»¶ä¸­å®šä¹‰çš„WALæ¥å£ä»¥åŠç›¸å…³æ–¹æ³•å·²ç»deprecatedï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚å› æ­¤æœ¬æ–‡é’ˆå¯¹tsdb/wal/wal.goæ–‡ä»¶è¿›è¡Œåˆ†æã€‚
// WAL is a write ahead log that can log new series labels and samples. // It must be completely read before new entries are logged. // // DEPRECATED: use wal pkg combined with the record codex instead.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="Prometheus WALæºç é˜…è¯»" />
<meta property="og:description" content="æ¦‚è¿° #  WAL(Write-ahead logging, é¢„å†™æ—¥å¿—)æ˜¯å…³ç³»å‹æ•°æ®åº“ä¸­åˆ©ç”¨æ—¥å¿—æ¥å®ç°äº‹åŠ¡æ€§å’ŒæŒä¹…æ€§çš„ä¸€ç§æŠ€æœ¯ï¼Œå³åœ¨æŸä¸ªæ“ä½œä¹‹å‰å…ˆå°†è¿™ä¸ªäº‹æƒ…è®°å½•ä¸‹æ¥ï¼Œä»¥ä¾¿ä¹‹åå¯¹æ•°æ®è¿›è¡Œå›æ»šï¼Œé‡è¯•ç­‰æ“ä½œä¿è¯æ•°æ®çš„å¯é æ€§ã€‚
Prometheusä¸ºäº†é˜²æ­¢ä¸¢å¤±æš‚å­˜åœ¨å†…å­˜ä¸­çš„è¿˜æœªè¢«å†™å…¥ç£ç›˜çš„ç›‘æ§æ•°æ®ï¼Œå¼•å…¥äº†WALæœºåˆ¶ã€‚WALè¢«åˆ†å‰²æˆé»˜è®¤å¤§å°ä¸º128Mçš„æ–‡ä»¶æ®µï¼ˆsegmentï¼‰ï¼Œä¹‹å‰ç‰ˆæœ¬é»˜è®¤å¤§å°æ˜¯256Mï¼Œæ–‡ä»¶æ®µä»¥æ•°å­—å‘½åï¼Œé•¿åº¦ä¸º8ä½çš„æ•´å½¢ã€‚WALçš„å†™å…¥å•ä½æ˜¯é¡µï¼ˆpageï¼‰ï¼Œæ¯é¡µçš„å¤§å°ä¸º32KBï¼Œæ‰€ä»¥æ¯ä¸ªæ®µå¤§å°å¿…é¡»æ˜¯é¡µçš„å¤§å°çš„æ•´æ•°å€ã€‚æ¯ä¸ªæ–‡ä»¶æ®µéƒ½æœ‰ä¸€ä¸ªâ€œ==å·²ä½¿ç”¨çš„é¡µï¼Ÿ==â€å±æ€§æ¥æ ‡è¯†åœ¨è¯¥æ®µä¸­å·²ç»åˆ†é…çš„é¡µæ•°ç›®ï¼Œå¦‚æœWALä¸€æ¬¡æ€§å†™å…¥çš„é¡µæ•°è¶…è¿‡ä¸€ä¸ªæ®µçš„ç©ºé—²é¡µæ•°ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶æ®µæ¥ä¿å­˜è¿™äº›é¡µï¼Œä»è€Œç¡®ä¿ä¸€æ¬¡æ€§å†™å…¥çš„é¡µä¸ä¼šè·¨æ®µå­˜å‚¨ã€‚
const ( DefaultSegmentSize = 128 * 1024 * 1024 // 128 MB  pageSize = 32 * 1024 // 32KB  recordHeaderSize = 7 ) æœ¬æ–‡æ˜¯åœ¨prometheus tsdbéƒ¨åˆ†æºç é˜…è¯»ä¹‹wal.LogSeriesåŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•ï¼Œç”±äºtsdb/wal.goæ–‡ä»¶ä¸­å®šä¹‰çš„WALæ¥å£ä»¥åŠç›¸å…³æ–¹æ³•å·²ç»deprecatedï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚å› æ­¤æœ¬æ–‡é’ˆå¯¹tsdb/wal/wal.goæ–‡ä»¶è¿›è¡Œåˆ†æã€‚
// WAL is a write ahead log that can log new series labels and samples. // It must be completely read before new entries are logged. // // DEPRECATED: use wal pkg combined with the record codex instead." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/prometheus-wal/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-12-23T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-12-23T00:00:00+00:00" />

<title>Prometheus WALæºç é˜…è¯» | é…±æ²¹ç‹</title>
<link rel="manifest" href="/manifest.json">
<link rel="icon" href="/favicon.png" type="image/x-icon">
<link rel="stylesheet" href="/book.min.46181bc93375ba932026e753b37c40e6ff8bb16a9ef770c78bcc663e4577b1ba.css" integrity="sha256-RhgbyTN1upMgJudTs3xA5v&#43;LsWqe93DHi8xmPkV3sbo=" crossorigin="anonymous">
  <script defer src="/flexsearch.min.js"></script>
  <script defer src="/en.search.min.e3d1bbac78330f1cc70982a957603bba2ca132f3b1f8b160e8efe21defc8e54b.js" integrity="sha256-49G7rHgzDxzHCYKpV2A7uiyhMvOx&#43;LFg6O/iHe/I5Us=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>é…±æ²¹ç‹</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  












  
<ul>
  
  <li>
    <a href="/posts/" >
        Blog
      </a>
  </li>
  
</ul>






</nav>




  <script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Prometheus WALæºç é˜…è¯»</strong>

  <label for="toc-control">
    
    <img src="/svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#æ¦‚è¿°">æ¦‚è¿°</a></li>
    <li><a href="#prometheus-storage-hierarchy">Prometheus storage hierarchy</a></li>
    <li><a href="#create-segment">Create Segment</a></li>
    <li><a href="#wal-repair">WAL Repair</a>
      <ul>
        <li><a href="#wal-reader">WAL Reader</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
<article class="markdown">
  <h1>
    <a href="/posts/prometheus-wal/">Prometheus WALæºç é˜…è¯»</a>
  </h1>
  
  <h5>December 23, 2021</h5>



  
  <div>
    
      <a href="/categories/prometheus/">Prometheus</a>, 
      <a href="/categories/golang/">golang</a>
  </div>
  

  
  <div>
    
      <a href="/tags/prometheus/">prometheus</a>, 
      <a href="/tags/golang/">golang</a>
  </div>
  



<hr>
<h2 id="æ¦‚è¿°">
  æ¦‚è¿°
  <a class="anchor" href="#%e6%a6%82%e8%bf%b0">#</a>
</h2>
<p>WAL(Write-ahead logging, é¢„å†™æ—¥å¿—)æ˜¯å…³ç³»å‹æ•°æ®åº“ä¸­åˆ©ç”¨æ—¥å¿—æ¥å®ç°äº‹åŠ¡æ€§å’ŒæŒä¹…æ€§çš„ä¸€ç§æŠ€æœ¯ï¼Œå³åœ¨æŸä¸ªæ“ä½œä¹‹å‰å…ˆå°†è¿™ä¸ªäº‹æƒ…è®°å½•ä¸‹æ¥ï¼Œä»¥ä¾¿ä¹‹åå¯¹æ•°æ®è¿›è¡Œå›æ»šï¼Œé‡è¯•ç­‰æ“ä½œä¿è¯æ•°æ®çš„å¯é æ€§ã€‚</p>
<p>Prometheusä¸ºäº†é˜²æ­¢ä¸¢å¤±æš‚å­˜åœ¨å†…å­˜ä¸­çš„è¿˜æœªè¢«å†™å…¥ç£ç›˜çš„ç›‘æ§æ•°æ®ï¼Œå¼•å…¥äº†WALæœºåˆ¶ã€‚WALè¢«åˆ†å‰²æˆé»˜è®¤å¤§å°ä¸º128Mçš„æ–‡ä»¶æ®µï¼ˆsegmentï¼‰ï¼Œä¹‹å‰ç‰ˆæœ¬é»˜è®¤å¤§å°æ˜¯256Mï¼Œæ–‡ä»¶æ®µä»¥æ•°å­—å‘½åï¼Œé•¿åº¦ä¸º8ä½çš„æ•´å½¢ã€‚WALçš„å†™å…¥å•ä½æ˜¯é¡µï¼ˆpageï¼‰ï¼Œæ¯é¡µçš„å¤§å°ä¸º32KBï¼Œæ‰€ä»¥æ¯ä¸ªæ®µå¤§å°å¿…é¡»æ˜¯é¡µçš„å¤§å°çš„æ•´æ•°å€ã€‚æ¯ä¸ªæ–‡ä»¶æ®µéƒ½æœ‰ä¸€ä¸ªâ€œ==å·²ä½¿ç”¨çš„é¡µï¼Ÿ==â€å±æ€§æ¥æ ‡è¯†åœ¨è¯¥æ®µä¸­å·²ç»åˆ†é…çš„é¡µæ•°ç›®ï¼Œå¦‚æœWALä¸€æ¬¡æ€§å†™å…¥çš„é¡µæ•°è¶…è¿‡ä¸€ä¸ªæ®µçš„ç©ºé—²é¡µæ•°ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶æ®µæ¥ä¿å­˜è¿™äº›é¡µï¼Œä»è€Œç¡®ä¿ä¸€æ¬¡æ€§å†™å…¥çš„é¡µ<strong>ä¸ä¼šè·¨æ®µå­˜å‚¨</strong>ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">const</span> (
     <span style="color:#a6e22e">DefaultSegmentSize</span> = <span style="color:#ae81ff">128</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span> <span style="color:#75715e">// 128 MB
</span><span style="color:#75715e"></span>     <span style="color:#a6e22e">pageSize</span>           = <span style="color:#ae81ff">32</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1024</span>         <span style="color:#75715e">// 32KB
</span><span style="color:#75715e"></span>     <span style="color:#a6e22e">recordHeaderSize</span>   = <span style="color:#ae81ff">7</span>
)
</code></pre></div><p>æœ¬æ–‡æ˜¯åœ¨<a href="https://www.jianshu.com/p/e0144be9692a">prometheus tsdbéƒ¨åˆ†æºç é˜…è¯»ä¹‹wal.LogSeries</a>åŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•ï¼Œç”±äº<code>tsdb/wal.go</code>æ–‡ä»¶ä¸­å®šä¹‰çš„WALæ¥å£ä»¥åŠç›¸å…³æ–¹æ³•å·²ç»deprecatedï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚å› æ­¤æœ¬æ–‡é’ˆå¯¹<code>tsdb/wal/wal.go</code>æ–‡ä»¶è¿›è¡Œåˆ†æã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// WAL is a write ahead log that can log new series labels and samples.
</span><span style="color:#75715e">// It must be completely read before new entries are logged.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// DEPRECATED: use wal pkg combined with the record codex instead.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">WAL</span> <span style="color:#66d9ef">interface</span> {
    <span style="color:#a6e22e">Reader</span>() <span style="color:#a6e22e">WALReader</span>
    <span style="color:#a6e22e">LogSeries</span>([]<span style="color:#a6e22e">RefSeries</span>) <span style="color:#66d9ef">error</span>
    <span style="color:#a6e22e">LogSamples</span>([]<span style="color:#a6e22e">RefSample</span>) <span style="color:#66d9ef">error</span>
    <span style="color:#a6e22e">LogDeletes</span>([]<span style="color:#a6e22e">Stone</span>) <span style="color:#66d9ef">error</span>
    <span style="color:#a6e22e">Truncate</span>(<span style="color:#a6e22e">mint</span> <span style="color:#66d9ef">int64</span>, <span style="color:#a6e22e">keep</span> <span style="color:#66d9ef">func</span>(<span style="color:#66d9ef">uint64</span>) <span style="color:#66d9ef">bool</span>) <span style="color:#66d9ef">error</span>
    <span style="color:#a6e22e">Close</span>() <span style="color:#66d9ef">error</span>
}
</code></pre></div><hr>
<h2 id="prometheus-storage-hierarchy">
  Prometheus storage hierarchy
  <a class="anchor" href="#prometheus-storage-hierarchy">#</a>
</h2>
<pre tabindex="0"><code>(ENV) ğŸº /Users/xsky/go/src/github.com/microyahoo/prometheus/data â˜ tree -h
.
â”œâ”€â”€ [ 192]  01DPE8T5XPQ9ZYHSNJYBJBKGR6
â”‚Â Â  â”œâ”€â”€ [  96]  chunks
â”‚Â Â  â”‚Â Â  â””â”€â”€ [7.1K]  000001
â”‚Â Â  â”œâ”€â”€ [ 22K]  index
â”‚Â Â  â”œâ”€â”€ [ 272]  meta.json
â”‚Â Â  â””â”€â”€ [   9]  tombstones
â”œâ”€â”€ [   0]  lock
â”œâ”€â”€ [ 20K]  queries.active
â””â”€â”€ [ 256]  wal
    â”œâ”€â”€ [   0]  00000050
    â”œâ”€â”€ [   0]  00000051
    â”œâ”€â”€ [   0]  00000052
    â”œâ”€â”€ [   0]  00000053
    â”œâ”€â”€ [ 10K]  00000054
    â””â”€â”€ [  96]  checkpoint.000049
        â””â”€â”€ [ 32K]  00000000

4 directories, 12 files
</code></pre><p>ä»ä¸Šé¢ç›®å½•ç»“æ„å¯ä»¥çœ‹å‡ºwalä¸»è¦åŒ…å«segmentæ–‡ä»¶ï¼Œcheckpointç›®å½•ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// WAL is a write ahead log that stores records in segment files.
</span><span style="color:#75715e">// It must be read from start to end once before logging new data.
</span><span style="color:#75715e">// If an error occurs during read, the repair procedure must be called
</span><span style="color:#75715e">// before it&#39;s safe to do further writes.
</span><span style="color:#75715e">//
</span><span style="color:#75715e">// Segments are written to in pages of 32KB, with records possibly split
</span><span style="color:#75715e">// across page boundaries.
</span><span style="color:#75715e">// Records are never split across segments to allow full segments to be
</span><span style="color:#75715e">// safely truncated. It also ensures that torn writes never corrupt records
</span><span style="color:#75715e">// beyond the most recent segment.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">WAL</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">dir</span>         <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">logger</span>      <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Logger</span>
    <span style="color:#a6e22e">segmentSize</span> <span style="color:#66d9ef">int</span>
    <span style="color:#a6e22e">mtx</span>         <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
    <span style="color:#a6e22e">segment</span>     <span style="color:#f92672">*</span><span style="color:#a6e22e">Segment</span> <span style="color:#75715e">// Active segment.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">donePages</span>   <span style="color:#66d9ef">int</span>      <span style="color:#75715e">// Pages written to the segment.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">page</span>        <span style="color:#f92672">*</span><span style="color:#a6e22e">page</span>    <span style="color:#75715e">// Active page.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">stopc</span>       <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">struct</span>{}
    <span style="color:#a6e22e">actorc</span>      <span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">func</span>()
    <span style="color:#a6e22e">closed</span>      <span style="color:#66d9ef">bool</span> <span style="color:#75715e">// To allow calling Close() more than once without blocking.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">compress</span>    <span style="color:#66d9ef">bool</span>
    <span style="color:#a6e22e">snappyBuf</span>   []<span style="color:#66d9ef">byte</span>

    <span style="color:#a6e22e">fsyncDuration</span>   <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">Summary</span>
    <span style="color:#a6e22e">pageFlushes</span>     <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">Counter</span>
    <span style="color:#a6e22e">pageCompletions</span> <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">Counter</span>
    <span style="color:#a6e22e">truncateFail</span>    <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">Counter</span>
    <span style="color:#a6e22e">truncateTotal</span>   <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">Counter</span>
    <span style="color:#a6e22e">currentSegment</span>  <span style="color:#a6e22e">prometheus</span>.<span style="color:#a6e22e">Gauge</span>
}
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Segment represents a segment file.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Segment</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#f92672">*</span><span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">File</span>
    <span style="color:#a6e22e">dir</span> <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">i</span>   <span style="color:#66d9ef">int</span>
}
</code></pre></div><p><img src="https://note.youdao.com/yws/api/personal/file/WEBb9810f4ea734eae8aec71710c79e3329?method=getImage&amp;version=12759&amp;cstk=-lHXuqC6" alt="" /></p>
<hr>
<h2 id="create-segment">
  Create Segment
  <a class="anchor" href="#create-segment">#</a>
</h2>
<p>åˆ›å»º<code>segment</code>ä¸»è¦æ˜¯é€šè¿‡<code>New</code>æ–¹æ³•æˆ–è€…<code>NewSize</code>æ–¹æ³•ã€‚å…¶ä¸­<code>NewSize</code>å¯ä»¥æŒ‡å®šsegmentçš„å¤§å°ï¼Œ<code>New</code>æ–¹æ³•ä¼ å…¥çš„æ˜¯é»˜è®¤çš„segmentå¤§å°ï¼Œå³128Mã€‚åŠ è½½DBæ—¶å¦‚æœWAL enabledçš„è¯ï¼Œåˆ™ä¼šè°ƒç”¨<code>NewSize</code>åˆ›å»ºæ–°çš„segmentï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ä¸‹é¢å¯¹<code>NewSize</code>è¿›è¡Œå±•å¼€ã€‚</p>
<pre tabindex="0"><code>wlog, err = wal.NewSize(l, r, filepath.Join(dir, &quot;wal&quot;), segmentSize, opts.WALCompression)
</code></pre><ul>
<li>é¦–å…ˆåˆ¤æ–­æ®µå¤§å°æ˜¯å¦æ˜¯<code>page</code>çš„æ•´æ•°å€ã€‚</li>
<li>å¦‚æœ<code>wal</code>ç›®å½•ä¸å­˜åœ¨çš„è¯åˆ™åˆ›å»º<code>wal</code>ç›®å½•ã€‚</li>
<li>åˆ›å»ºWALæ•°æ®ç»“æ„ã€‚å› ä¸ºWALæ˜¯ä¸<code>active segment</code>å…³è”çš„ï¼Œæ‰€ä»¥WAL <code>segmentSize</code>å³ä¸ºæŒ‡å®šçš„segmentSizeã€‚</li>
<li>æŸ¥æ‰¾ç›®å‰WALä¸­æ‰€æœ‰çš„segmentè®°å½•ã€‚å› ä¸ºsegmentæ˜¯æŒ‰ç…§æ•°å­—å‘½åå¹¶é€’å¢çš„ï¼Œæ‰€ä»¥å…¶åå­—å³ä¸ºç´¢å¼•ï¼Œå…¶å†…éƒ¨è¡¨è¿°ä¸º<code>segmentRef</code>ï¼Œnameä¸ºå…¶æ–‡ä»¶åï¼Œå³å‰ç¼€ä¸º0å¡«å……çš„å…«ä½æ•´å½¢è¡¨ç¤ºï¼Œindexå³ä¸ºå…¶æ•´å½¢è¡¨ç¤ºã€‚</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">segmentRef</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">name</span>  <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">index</span> <span style="color:#66d9ef">int</span>
}
</code></pre></div><ul>
<li>ä¸Šé¢æ­¥éª¤è·å–åˆ°last segmentä¹‹åï¼Œä¸‹ä¸€ä¸ªè¦å†™å…¥çš„segment indexå³ä¸º<code>last+1</code>ï¼Œåˆ›å»ºæ–°çš„segmentã€‚</li>
<li>å°†æ–°åˆ›å»ºçš„segmentè®¾ç½®ä¸ºWALçš„active segmentï¼ŒåŒæ—¶æ ¹æ®segmentæ–‡ä»¶å¤§å°è®¾ç½®WAL <code>donePages</code>ï¼Œå°†WAL <code>currentSegment</code>è®¾ç½®ä¸ºæ–°åˆ›å»ºçš„segmentçš„indexã€‚</li>
<li>å¯åŠ¨æ–°çš„goroutineæ‰§è¡Œ<code>actorc</code>é€šé“å‘é€è¿‡æ¥çš„funcã€‚ä¸»è¦ç”¨äºæ‰§è¡Œæ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œä¾‹å¦‚å°†segmentä¸­çš„æ•°æ®<code>fsync</code>åˆ°diskä¸­ã€‚</li>
</ul>
<hr>
<h2 id="wal-repair">
  WAL Repair
  <a class="anchor" href="#wal-repair">#</a>
</h2>
<blockquote>
<p>Repair attempts to repair the WAL based on the error.
It discards all data after the corruption.</p>
</blockquote>
<p>éœ€è¦æ³¨æ„çš„æ˜¯<code>Repair</code>ä»…èƒ½ä¿®å¤<code>CorruptionErr</code>ã€‚<code>CorruptionErr</code>ä¸­æŒ‡å®šäº†ç›®å½•ï¼Œæ®µï¼Œåç§»é‡ä»¥åŠå…·ä½“çš„é”™è¯¯ä¿¡æ¯ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// CorruptionErr is an error that&#39;s returned when corruption is encountered.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CorruptionErr</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">Dir</span>     <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">Segment</span> <span style="color:#66d9ef">int</span>
    <span style="color:#a6e22e">Offset</span>  <span style="color:#66d9ef">int64</span>
    <span style="color:#a6e22e">Err</span>     <span style="color:#66d9ef">error</span>
}
</code></pre></div><ul>
<li>é¦–å…ˆè·å–walç›®å½•ä¸­æ‰€æœ‰çš„segmentsã€‚</li>
<li><strong>åˆ é™¤</strong><code>CorruptionErr.Segment</code>ç´¢å¼•ä¹‹åçš„æ‰€æœ‰çš„segmentsã€‚</li>
<li>å…³é—­WALçš„<code>active segment</code>ã€‚</li>
<li>å°†<code>CorruptionErr.Segment</code>ç´¢å¼•çš„segmentåŠ ä¸Š<code>.repair</code>åç¼€å¹¶é‡å‘½åã€‚</li>
<li>åˆ›å»ºä¸€ä¸ªæ–°çš„segmentæ–‡ä»¶ï¼Œå…¶indexä¸º<code>CorruptionErr.Segment</code>ï¼Œå³Corruption segmenté‡å‘½åä¹‹åé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„segmentæ–‡ä»¶ï¼Œå¹¶å°†WALçš„active segmentæŒ‡å‘æ–°åˆ›å»ºçš„segmentã€‚</li>
<li>å°†Corruption segmentä¸­çš„æ•°æ®è¯»åˆ°æ–°åˆ›å»ºçš„segmentæ–‡ä»¶ä¸­ï¼Œè¯»åˆ°<code>CorruptionErr.Offset</code>ä¸ºæ­¢ã€‚
<ul>
<li>éå†è¯»å–corrupted segmentä¸­çš„recordsï¼Œå°†å…¶å†™å…¥new segmentä¸­ã€‚</li>
</ul>
</li>
<li>å°†active pageåˆ·å…¥fileã€‚</li>
<li>å…³é—­corrupted segmentæ–‡ä»¶ï¼Œå¹¶åˆ é™¤ã€‚</li>
<li>åˆ›å»ºä¸€ä¸ªæ–°çš„segmentæ–‡ä»¶ï¼Œå…¶indexä¸º<code>CorruptionErr.Segment</code>çš„index+1ï¼Œå¹¶å°†active segmentæŒ‡å‘æ–°åˆ›å»ºçš„segmentã€‚</li>
</ul>
<p>ä¸‹é¢æˆªå–<code>tsdb/wal/wal.go</code>æ–‡ä»¶ä¸­çš„éƒ¨åˆ†Repairçš„ä»£ç è¿›è¡Œåˆ†æã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go">    <span style="color:#75715e">// æ‰“å¼€corrupted segmentæ–‡ä»¶å¹¶è¯»å–å…¶ä¸­çš„recordsã€‚
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">r</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewReader</span>(<span style="color:#a6e22e">f</span>))

    <span style="color:#75715e">// ä¸‹é¢WAL Readeréƒ¨åˆ†æœ‰è¯¦ç»†è§£é‡Š
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Next</span>() {
        <span style="color:#75715e">// Add records only up to the where the error was.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è¯»å–åˆ°å‡ºé”™çš„åœ°æ–¹ä¸ºæ­¢ã€‚
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Offset</span>() <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">cerr</span>.<span style="color:#a6e22e">Offset</span> {
            <span style="color:#66d9ef">break</span>
        }
        <span style="color:#75715e">// ä¸‹é¢ç€é‡ä»‹ç»æ­¤æ–¹æ³•
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Log</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Record</span>()); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;insert record&#34;</span>)
        }
    }
    <span style="color:#75715e">// We expect an error here from r.Err(), so nothing to handle.
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// We need to pad to the end of the last page in the repaired segment
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">flushPage</span>(<span style="color:#66d9ef">true</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;flush page in repair&#34;</span>)
    }

    <span style="color:#75715e">// We explicitly close even when there is a defer for Windows to be
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// able to delete it. The defer is in place to close it in-case there
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// are errors above.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Close</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;close corrupted file&#34;</span>)
    }
    <span style="color:#75715e">// åˆ é™¤.repairæ–‡ä»¶
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">os</span>.<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">tmpfn</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;delete corrupted segment&#34;</span>)
    }

    <span style="color:#75715e">// Explicitly close the segment we just repaired to avoid issues with Windows.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Close</span>()
    
    <span style="color:#75715e">// We always want to start writing to a new Segment rather than an existing
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Segment, which is handled by NewSize, but earlier in Repair we&#39;re deleting
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// all segments that come after the corrupted Segment. Recreate a new Segment here.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// åˆ›å»ºæ–°çš„segment fileï¼Œå¹¶å°†active segmentæŒ‡å‘æ­¤æ–°åˆ›å»ºçš„segment file
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">CreateSegment</span>(<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">dir</span>, <span style="color:#a6e22e">cerr</span>.<span style="color:#a6e22e">Segment</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">setSegment</span>(<span style="color:#a6e22e">s</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
    }
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</code></pre></div><p>Repairçš„æ ¸å¿ƒå°±æ˜¯å°†corrupted segmentæ–‡ä»¶ä¸­çš„æ•°æ®å†™å…¥æ–°çš„segmentä¸­ï¼Œç„¶ååˆ é™¤corrupted segmentæ–‡ä»¶ã€‚ä¸‹é¢ç€é‡ä»‹ç»å…¶å†™å…¥è¿‡ç¨‹ï¼Œä¸»è¦æ˜¯è°ƒç”¨WALçš„<code>log</code>æ–¹æ³•ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// log writes rec to the log and forces a flush of the current page if:
</span><span style="color:#75715e">// - the final record of a batch
</span><span style="color:#75715e">// - the record is bigger than the page size
</span><span style="color:#75715e">// - the current page is full.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">w</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">WAL</span>) <span style="color:#a6e22e">log</span>(<span style="color:#a6e22e">rec</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">final</span> <span style="color:#66d9ef">bool</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#75715e">// When the last page flush failed the page will remain full.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// When the page is full, need to flush it before trying to add more records to it.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å¦‚æœWALçš„active pageå·²æ»¡ï¼Œåˆ™flushåˆ°fileï¼Œå¹¶é‡ç½®æ­¤page
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">full</span>() {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">flushPage</span>(<span style="color:#66d9ef">true</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
    }
    <span style="color:#75715e">// If the record is too big to fit within the active page in the current
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// segment, terminate the active segment and advance to the next one.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// This ensures that records do not cross segment boundaries.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">left</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">remaining</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">recordHeaderSize</span>                                   <span style="color:#75715e">// Free space in the active page.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">left</span> <span style="color:#f92672">+=</span> (<span style="color:#a6e22e">pageSize</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">recordHeaderSize</span>) <span style="color:#f92672">*</span> (<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">pagesPerSegment</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">donePages</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#75715e">// Free pages in the active segment.
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// å¦‚æœrecordçš„é•¿åº¦å¤§äºactive segmentçš„å‰©ä½™å¯ç”¨ç©ºé—´ï¼Œåˆ™åˆ›å»ºæ–°çš„segment
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">rec</span>) &gt; <span style="color:#a6e22e">left</span> {
        <span style="color:#75715e">// 1. å¦‚æœactive pageå·²åˆ†é…å¤§å°ä¸ä¸º0ï¼Œåˆ™flush pageåˆ°fileã€‚
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 2. åˆ›å»ºæ–°çš„segment fileã€‚
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// 3. å°†ä¸Šä¸€ä¸ªsegment fileçš„æ•°æ®fsyncåˆ°ç£ç›˜ã€‚
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">nextSegment</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
    }

    <span style="color:#a6e22e">compressed</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">false</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">compress</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">rec</span>) &gt; <span style="color:#ae81ff">0</span> {
        <span style="color:#75715e">// The snappy library uses `len` to calculate if we need a new buffer.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// In order to allocate as few buffers as possible make the length
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// equal to the capacity.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å¦‚æœWAL compress enabledï¼Œåˆ™å°†recordæ•°æ®ç¼–ç ä¸ºsnappyBufï¼Œ
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å°†recæŒ‡å‘å‹ç¼©åçš„snappyBufæ•°æ®è®°å½•ã€‚
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">snappyBuf</span> = <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">snappyBuf</span>[:cap(<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">snappyBuf</span>)]
        <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">snappyBuf</span> = <span style="color:#a6e22e">snappy</span>.<span style="color:#a6e22e">Encode</span>(<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">snappyBuf</span>, <span style="color:#a6e22e">rec</span>)
        <span style="color:#66d9ef">if</span> len(<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">snappyBuf</span>) &lt; len(<span style="color:#a6e22e">rec</span>) {
            <span style="color:#a6e22e">rec</span> = <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">snappyBuf</span>
            <span style="color:#a6e22e">compressed</span> = <span style="color:#66d9ef">true</span>
        }
    }

    <span style="color:#75715e">// Populate as many pages as necessary to fit the record.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// Be careful to always do one pass to ensure we write zero-length records.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> len(<span style="color:#a6e22e">rec</span>) &gt; <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
        <span style="color:#a6e22e">p</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">page</span>

        <span style="color:#75715e">// Find how much of the record we can fit into the page.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">var</span> (
            <span style="color:#a6e22e">l</span>    = <span style="color:#a6e22e">min</span>(len(<span style="color:#a6e22e">rec</span>), (<span style="color:#a6e22e">pageSize</span><span style="color:#f92672">-</span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">alloc</span>)<span style="color:#f92672">-</span><span style="color:#a6e22e">recordHeaderSize</span>)
            <span style="color:#a6e22e">part</span> = <span style="color:#a6e22e">rec</span>[:<span style="color:#a6e22e">l</span>]
            <span style="color:#75715e">// bufæŒ‡å‘page.bufçš„offsetä¸ºpage.alloc
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">buf</span>  = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">buf</span>[<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">alloc</span>:] 
            <span style="color:#a6e22e">typ</span>  <span style="color:#a6e22e">recType</span>
        )

        <span style="color:#66d9ef">switch</span> {
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">part</span>) <span style="color:#f92672">==</span> len(<span style="color:#a6e22e">rec</span>):
            <span style="color:#a6e22e">typ</span> = <span style="color:#a6e22e">recFull</span>
        <span style="color:#66d9ef">case</span> len(<span style="color:#a6e22e">part</span>) <span style="color:#f92672">==</span> len(<span style="color:#a6e22e">rec</span>):
            <span style="color:#a6e22e">typ</span> = <span style="color:#a6e22e">recLast</span>
        <span style="color:#66d9ef">case</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
            <span style="color:#a6e22e">typ</span> = <span style="color:#a6e22e">recFirst</span>
        <span style="color:#66d9ef">default</span>:
            <span style="color:#a6e22e">typ</span> = <span style="color:#a6e22e">recMiddle</span>
        }
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">compressed</span> {
            <span style="color:#a6e22e">typ</span> <span style="color:#f92672">|=</span> <span style="color:#a6e22e">snappyMask</span>
        }
        <span style="color:#75715e">// åˆ¤æ–­recordçš„typeå’Œæ˜¯å¦compressï¼Œå¹¶å°†å…¶å†™å…¥bufçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// æ¥ç€å†™å…¥2å­—èŠ‚çš„é•¿åº¦ä¸ºmin(len(record), (pageSize-p.alloc)-recordHeaderSize)ï¼Œ
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ä¹Ÿå°±æ˜¯è¯´æœ‰å¯èƒ½recordçš„é•¿åº¦å¤§äºactive pageæ‰€èƒ½åˆ†é…çš„æœ€å¤§é•¿åº¦ï¼Œ
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// è¿™æ ·recordå°±ä¼šè·¨pageï¼Œä½†æ˜¯ä¸èƒ½è·¨segmentã€‚
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// ç„¶åå†™å…¥4ä¸ªå­—èŠ‚çš„CRC
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">buf</span>[<span style="color:#ae81ff">0</span>] = byte(<span style="color:#a6e22e">typ</span>)
        <span style="color:#a6e22e">crc</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">crc32</span>.<span style="color:#a6e22e">Checksum</span>(<span style="color:#a6e22e">part</span>, <span style="color:#a6e22e">castagnoliTable</span>)
        <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">BigEndian</span>.<span style="color:#a6e22e">PutUint16</span>(<span style="color:#a6e22e">buf</span>[<span style="color:#ae81ff">1</span>:], uint16(len(<span style="color:#a6e22e">part</span>)))
        <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">BigEndian</span>.<span style="color:#a6e22e">PutUint32</span>(<span style="color:#a6e22e">buf</span>[<span style="color:#ae81ff">3</span>:], <span style="color:#a6e22e">crc</span>)

        <span style="color:#75715e">// ç´§æ¥ç€headerå†™å…¥recordæ•°æ®è®°å½•ï¼Œå¯èƒ½æ˜¯ä¸€éƒ¨åˆ†ã€‚
</span><span style="color:#75715e"></span>        copy(<span style="color:#a6e22e">buf</span>[<span style="color:#a6e22e">recordHeaderSize</span>:], <span style="color:#a6e22e">part</span>)
        <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">alloc</span> <span style="color:#f92672">+=</span> len(<span style="color:#a6e22e">part</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">recordHeaderSize</span>

        <span style="color:#75715e">// å¦‚æœpageå·²æ»¡ï¼Œåˆ™flushåˆ°fileä¸­ã€‚
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">full</span>() {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">flushPage</span>(<span style="color:#66d9ef">true</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
            }
        }
        <span style="color:#a6e22e">rec</span> = <span style="color:#a6e22e">rec</span>[<span style="color:#a6e22e">l</span>:]
    }
    
    <span style="color:#75715e">// If it&#39;s the final record of the batch and the page is not empty, flush it.
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">final</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">page</span>.<span style="color:#a6e22e">alloc</span> &gt; <span style="color:#ae81ff">0</span> {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">flushPage</span>(<span style="color:#66d9ef">false</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
    }

    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><h3 id="wal-reader">
  WAL Reader
  <a class="anchor" href="#wal-reader">#</a>
</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Reader reads WAL records from an io.Reader.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Reader</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">rdr</span>       <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Reader</span>
    <span style="color:#a6e22e">err</span>       <span style="color:#66d9ef">error</span>
    <span style="color:#a6e22e">rec</span>       []<span style="color:#66d9ef">byte</span>
    <span style="color:#a6e22e">snappyBuf</span> []<span style="color:#66d9ef">byte</span>
    <span style="color:#a6e22e">buf</span>       [<span style="color:#a6e22e">pageSize</span>]<span style="color:#66d9ef">byte</span>
    <span style="color:#a6e22e">total</span>     <span style="color:#66d9ef">int64</span>   <span style="color:#75715e">// Total bytes processed.
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">curRecTyp</span> <span style="color:#a6e22e">recType</span> <span style="color:#75715e">// Used for checking that the last record is not torn.
</span><span style="color:#75715e"></span>}
</code></pre></div><p>å…¶ä¸­Readerä»rdrä¸­è¯»å–recordsï¼Œç›¸å½“äºæŠŠio.Readeråšäº†ä¸€å±‚åŒ…è£…ï¼›bufä¸ºå¤§å°ä¸ºpageSizeçš„å­—èŠ‚æ•°ç»„ã€‚</p>
<pre tabindex="0"><code>+--------------------------------------------------+
|                     Reader.buf                   |
+-----------------------------------+--------------+
|               hdr                 |     buf      |
+-----------+----------+------------+--------------+
| type &lt;1b&gt; | len &lt;2b&gt; | CRC32 &lt;4b&gt; | data &lt;bytes&gt; |
+-----------+----------+------------+--------------+

</code></pre><p>the record fragment is encoded as:</p>
<pre tabindex="0"><code>+-----------+----------+------------+--------------+
| type &lt;1b&gt; | len &lt;2b&gt; | CRC32 &lt;4b&gt; | data &lt;bytes&gt; |
+-----------+----------+------------+--------------+
</code></pre><p>The type flag has the following states:</p>
<ul>
<li><code>0</code>: rest of page will be empty</li>
<li><code>1</code>: a full record encoded in a single fragment</li>
<li><code>2</code>: first fragment of a record</li>
<li><code>3</code>: middle fragment of a record</li>
<li><code>4</code>: final fragment of a record</li>
</ul>
<p>å…¶ä¸­typeå ç”¨ä¸€ä¸ªbyteï¼Œç”±äºtype flagåªæœ‰äº”ç§çŠ¶æ€ï¼Œ3 bitså°±å¯ä»¥è¡¨ç¤ºäº†ã€‚å‰4ä¸ª bitæœªåˆ†é…ï¼Œç¬¬5ä¸ªbitè¡¨ç¤ºæ˜¯å¦<code>å‹ç¼©</code>ï¼Œæœ€åä¸‰ä¸ªbitè¡¨ç¤º<code>record type</code>ã€‚</p>
<pre tabindex="0"><code>+--------------------+-------------------------------+------------------------+
| 4 bits unallocated | 1 bit snappy compression flag |   3 bit record type    |
+--------------------+-------------------------------+------------------------+
</code></pre><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Next advances the reader to the next records and returns true if it exists.
</span><span style="color:#75715e">// It must not be called again after it returned false.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Reader</span>) <span style="color:#a6e22e">Next</span>() <span style="color:#66d9ef">bool</span> {
    <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">next</span>()
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Cause</span>(<span style="color:#a6e22e">err</span>) <span style="color:#f92672">==</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">EOF</span> {
        <span style="color:#75715e">// The last WAL segment record shouldn&#39;t be torn(should be full or last).
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// The last record would be torn after a crash just before
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// the last record part could be persisted to disk.
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">curRecTyp</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">recFirst</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">curRecTyp</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">recMiddle</span> {
            <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;last record is torn&#34;</span>)
        }
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
    }
    <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">err</span>
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Reader</span>) <span style="color:#a6e22e">next</span>() (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#75715e">// We have to use r.buf since allocating byte arrays here fails escape
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// analysis and ends up on the heap, even though it seemingly should not.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// å‰é¢7ä¸ªbyteä»£è¡¨headerï¼Œåé¢çš„ä¸ºdata
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">hdr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">buf</span>[:<span style="color:#a6e22e">recordHeaderSize</span>]
    <span style="color:#a6e22e">buf</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">buf</span>[<span style="color:#a6e22e">recordHeaderSize</span>:]

    <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">rec</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">rec</span>[:<span style="color:#ae81ff">0</span>]
    <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">snappyBuf</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">snappyBuf</span>[:<span style="color:#ae81ff">0</span>]

    <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>
    <span style="color:#66d9ef">for</span> {
        <span style="color:#75715e">// é¦–å…ˆä»rdrä¸­è¯»å–ä¸€ä¸ªå­—èŠ‚
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">rdr</span>, <span style="color:#a6e22e">hdr</span>[:<span style="color:#ae81ff">1</span>]); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;read first header byte&#34;</span>)
        }
        <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">total</span><span style="color:#f92672">++</span>
        <span style="color:#75715e">// è·å–record typeï¼Œå¹¶åˆ¤æ–­æ˜¯å¦å‹ç¼©
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">curRecTyp</span> = <span style="color:#a6e22e">recTypeFromHeader</span>(<span style="color:#a6e22e">hdr</span>[<span style="color:#ae81ff">0</span>])
        <span style="color:#a6e22e">compressed</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">hdr</span>[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">snappyMask</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span>

        <span style="color:#75715e">// Gobble up zero bytes.
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// å¦‚æœrecord typeä¸ºrecPageTermï¼Œä»£è¡¨åé¢pageå‰©ä½™æ•°æ®å…¨éƒ¨ä¸º0å¡«å……ã€‚å³ç¬¬ä¸€ä¸ªbyteä¸ºtypeï¼Œåé¢å…¨æ˜¯0ã€‚
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">curRecTyp</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">recPageTerm</span> {
            <span style="color:#75715e">// recPageTerm is a single byte that indicates the rest of the page is padded.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// If it&#39;s the first byte in a page, buf is too small and
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// needs to be resized to fit pageSize-1 bytes.
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">buf</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">buf</span>[<span style="color:#ae81ff">1</span>:]

            <span style="color:#75715e">// We are pedantic and check whether the zeros are actually up
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// to a page boundary.
</span><span style="color:#75715e"></span>            <span style="color:#75715e">// It&#39;s not strictly necessary but may catch sketchy state early.
</span><span style="color:#75715e"></span>            <span style="color:#a6e22e">k</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">pageSize</span> <span style="color:#f92672">-</span> (<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">total</span> <span style="color:#f92672">%</span> <span style="color:#a6e22e">pageSize</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">k</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">pageSize</span> {
                <span style="color:#66d9ef">continue</span> <span style="color:#75715e">// Initial 0 byte was last page byte.
</span><span style="color:#75715e"></span>            }
            <span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">rdr</span>, <span style="color:#a6e22e">buf</span>[:<span style="color:#a6e22e">k</span>])
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;read remaining zeros&#34;</span>)
            }
            <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">total</span> <span style="color:#f92672">+=</span> int64(<span style="color:#a6e22e">n</span>)

            <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">buf</span>[:<span style="color:#a6e22e">k</span>] {
                <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
                    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;unexpected non-zero byte in padded page&#34;</span>)
                }
            }
            <span style="color:#66d9ef">continue</span>
        }
        <span style="color:#75715e">// è¯»å–å‰©ä½™çš„6ä¸ªbyteï¼Œåˆ†åˆ«ä»£è¡¨lengthå’Œcrc
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">rdr</span>, <span style="color:#a6e22e">hdr</span>[<span style="color:#ae81ff">1</span>:])
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Wrap</span>(<span style="color:#a6e22e">err</span>, <span style="color:#e6db74">&#34;read remaining header&#34;</span>)
        }
        <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">total</span> <span style="color:#f92672">+=</span> int64(<span style="color:#a6e22e">n</span>)

        <span style="color:#66d9ef">var</span> (
            <span style="color:#a6e22e">length</span> = <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">BigEndian</span>.<span style="color:#a6e22e">Uint16</span>(<span style="color:#a6e22e">hdr</span>[<span style="color:#ae81ff">1</span>:])
            <span style="color:#a6e22e">crc</span>    = <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">BigEndian</span>.<span style="color:#a6e22e">Uint32</span>(<span style="color:#a6e22e">hdr</span>[<span style="color:#ae81ff">3</span>:])
        )

        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">length</span> &gt; <span style="color:#a6e22e">pageSize</span><span style="color:#f92672">-</span><span style="color:#a6e22e">recordHeaderSize</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;invalid record size %d&#34;</span>, <span style="color:#a6e22e">length</span>)
        }
        <span style="color:#75715e">// è¯»å–é•¿åº¦ä¸ºlengthçš„æ•°æ®ï¼Œå¹¶è®¡ç®—å…¶crcå€¼æ˜¯å¦ä¸headerä¸­çš„crcç›¸ç­‰ã€‚
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">rdr</span>, <span style="color:#a6e22e">buf</span>[:<span style="color:#a6e22e">length</span>])
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">total</span> <span style="color:#f92672">+=</span> int64(<span style="color:#a6e22e">n</span>)

        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">!=</span> int(<span style="color:#a6e22e">length</span>) {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;invalid size: expected %d, got %d&#34;</span>, <span style="color:#a6e22e">length</span>, <span style="color:#a6e22e">n</span>)
        }
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">crc32</span>.<span style="color:#a6e22e">Checksum</span>(<span style="color:#a6e22e">buf</span>[:<span style="color:#a6e22e">length</span>], <span style="color:#a6e22e">castagnoliTable</span>); <span style="color:#a6e22e">c</span> <span style="color:#f92672">!=</span> <span style="color:#a6e22e">crc</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;unexpected checksum %x, expected %x&#34;</span>, <span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">crc</span>)
        }
        
        <span style="color:#75715e">// å¦‚æœä¸ºå‹ç¼©æ•°æ®ï¼Œåˆ™å°†å…¶å­˜æ”¾åœ¨snappyBufä¸­ï¼Œåé¢è¯»å–å®Œæˆåè¿›è¡Œdecodeã€‚
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">compressed</span> {
            <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">snappyBuf</span> = append(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">snappyBuf</span>, <span style="color:#a6e22e">buf</span>[:<span style="color:#a6e22e">length</span>]<span style="color:#f92672">...</span>)
        } <span style="color:#66d9ef">else</span> {
            <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">rec</span> = append(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">rec</span>, <span style="color:#a6e22e">buf</span>[:<span style="color:#a6e22e">length</span>]<span style="color:#f92672">...</span>)
        }

        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">validateRecord</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">curRecTyp</span>, <span style="color:#a6e22e">i</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
            <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
        }
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">curRecTyp</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">recLast</span> <span style="color:#f92672">||</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">curRecTyp</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">recFull</span> {
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">compressed</span> <span style="color:#f92672">&amp;&amp;</span> len(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">snappyBuf</span>) &gt; <span style="color:#ae81ff">0</span> {
                <span style="color:#75715e">// The snappy library uses `len` to calculate if we need a new buffer.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// In order to allocate as few buffers as possible make the length
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// equal to the capacity.
</span><span style="color:#75715e"></span>                <span style="color:#75715e">// å°†å‹ç¼©çš„æ•°æ®è¿›è¡Œè§£ç ã€‚
</span><span style="color:#75715e"></span>                <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">rec</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">rec</span>[:cap(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">rec</span>)]
                <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">rec</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">snappy</span>.<span style="color:#a6e22e">Decode</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">rec</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">snappyBuf</span>)
                <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
            }
            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
        }
        <span style="color:#75715e">// Only increment i for non-zero records since we use it
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// to determine valid content record sequences.
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span>
    }
}
</code></pre></div><p><code>Next</code>æ–¹æ³•ä»<code>rdr</code>ä¸­è¯»å–recordï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›trueã€‚æ¯æ¬¡æœ€å¤šè¯»å–<code>pageSize-recordHeaderSize</code>å¤§å°çš„æ•°æ®ï¼Œç›´åˆ°è¯»å–å®Œæ•´çš„<code>record</code>ï¼Œå¦‚æœæ•°æ®è¢«å‹ç¼©ï¼Œåˆ™éœ€è¦<code>decode</code>ï¼Œæœ€åçš„recordå­˜å‚¨åœ¨<code>Reader.rec</code>å­—æ®µä¸­ã€‚</p>
<h4 id="é—®é¢˜ç‚¹">
  é—®é¢˜ç‚¹
  <a class="anchor" href="#%e9%97%ae%e9%a2%98%e7%82%b9">#</a>
</h4>
<ol>
<li>ä¸ºä»€ä¹ˆéœ€è¦<code>recPageTerm</code>ç±»å‹ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯æµªè´¹äº†ä¸€æ•´ä¸ªpageå¤§å°çš„ç©ºé—´ï¼Ÿ</li>
<li><code>record</code>ä»£è¡¨ä»€ä¹ˆï¼Ÿ</li>
<li>ä¸ºä»€ä¹ˆ<code>length</code>ä¸èƒ½å¤§äº<code>pageSize-recordHeaderSize</code>ï¼Ÿ</li>
<li>recordçš„å¤§å°ä¼šå¤§äºsegmentå—ï¼Ÿ</li>
</ol>
<hr>
<h2 id="references">
  References
  <a class="anchor" href="#references">#</a>
</h2>
<ul>
<li><a href="https://github.com/prometheus/prometheus/blob/master/tsdb/docs/format/wal.md">WAL disk format</a></li>
<li><a href="https://www.jianshu.com/p/e0144be9692a">prometheus tsdbéƒ¨åˆ†æºç é˜…è¯»ä¹‹wal.LogSeries</a></li>
<li><a href="https://segmentfault.com/a/1190000020500985?utm_source=tag-newest">è¯¦è§£varintç¼–ç åŸç†</a></li>
<li><a href="https://github.com/facebook/rocksdb/wiki/Write-Ahead-Log-File-Format">RocksDB WAL file format</a></li>
</ul>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#æ¦‚è¿°">æ¦‚è¿°</a></li>
    <li><a href="#prometheus-storage-hierarchy">Prometheus storage hierarchy</a></li>
    <li><a href="#create-segment">Create Segment</a></li>
    <li><a href="#wal-repair">WAL Repair</a>
      <ul>
        <li><a href="#wal-reader">WAL Reader</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












