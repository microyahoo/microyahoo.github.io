[{"id":0,"href":"/posts/etcd_raft/","title":"etcd raft","section":"Blog","content":" etcd ä»£ç åˆ†æå¯ä»¥å‚è€ƒï¼šetcd æ³¨è§£ç‰ˆ ï¼Œä¹Ÿæ¬¢è¿å¤§å®¶äº¤æµè®¨è®º\nRaft message type #  Rafté›†ç¾¤ä¸­èŠ‚ç‚¹ä¹‹é—´çš„é€šä¿¡éƒ½æ˜¯é€šè¿‡ä¼ é€’ä¸åŒçš„Messageæ¥å®Œæˆçš„ï¼ŒMessageç±»å‹ æœ‰å¾ˆå¤šç§ï¼Œä¸‹é¢ä»‹ç»éƒ¨åˆ†ï¼š\n MsgHup   ç”¨äºé€‰ä¸¾ï¼Œå¯¹äºfolloweræˆ–è€…candidateï¼Œå…¶tickå‡½æ•°å¯¹åº”tickElectionã€‚å¦‚æœfolloweræˆ–è€…candidateåœ¨é€‰ä¸¾è¶…æ—¶æ—¶é—´éƒ½æ²¡æœ‰æ”¶åˆ°å¿ƒè·³ä¿¡æ¯ï¼Œå®ƒå°†å‘é€MsgHupåˆ°Stepæ–¹æ³•ï¼Œå…¶è§’è‰²å°†å˜ä¸ºcandidateï¼ˆå¯¹äºfollowerèŠ‚ç‚¹ï¼‰å¹¶å‘èµ·æ–°ä¸€è½®é€‰ä¸¾ã€‚\n  MsgBeat   MsgAppæ˜¯ä¸€ä¸ªå†…éƒ¨ä½¿ç”¨çš„ç±»å‹ï¼Œå¯¹äºleaderèŠ‚ç‚¹ï¼Œå…¶tickå‡½æ•°å¯¹åº”tickHeartbeatï¼Œå‘¨æœŸæ€§åœ°å‘followerèŠ‚ç‚¹å‘é€MsgHeartbeatæ¶ˆæ¯ã€‚\n  MsgProp   MsgPropæè®®é™„åŠ æ•°æ®åˆ°log entriesï¼Œè€Œä¸”å®ƒä¼šé‡å®šå‘proposeåˆ°leaderèŠ‚ç‚¹ã€‚å› æ­¤ï¼Œsendæ–¹æ³•ç”¨hardStateè¦†å†™äº†Messageçš„termå·ã€‚-\n å½“MsgPropä¼ é€’åˆ°leaderçš„stepæ–¹æ³•ï¼Œleaderé¦–å…ˆä¼šè°ƒç”¨appendEntryæ–¹æ³•å°†entriesé™„åŠ åˆ°å®ƒçš„logï¼Œæ¥ç€ä¼šè°ƒç”¨bcastAppendæ–¹æ³•å‘é€entriesåˆ°peersã€‚ å½“MsgPropä¼ é€’åˆ°candidateï¼Œåˆ™ç›´æ¥ä¸¢å¼ƒã€‚ å½“ä¼ é€’åˆ°followerï¼ŒMsgPropå­˜å‚¨åˆ°followerçš„mailboxï¼Œå³msgsï¼Œå®ƒä¿å­˜äº†å‘é€è€…çš„IDï¼Œéšåé€šè¿‡rafthttpåŒ…è½¬å‘åˆ°leaderã€‚    MsgApp   å¤åˆ¶log entriesã€‚leaderè°ƒç”¨bcastAppendæ–¹æ³•ï¼Œå…¶ä¼šè°ƒç”¨bcastAppendæ–¹æ³•å‘é€å³å°†è¦å¤åˆ¶çš„MsgAppç±»å‹çš„logsã€‚å½“MsgAppè¢«ä¼ é€’åˆ°candidateçš„Stepæ–¹æ³•ï¼Œcandidateå°†ä¼šrevert back to followerï¼Œè¡¨ç¤ºå­˜åœ¨æœ‰æ•ˆçš„leaderåœ¨å‘é€MsgAppæ¶ˆæ¯ã€‚candidateå’Œfollowerä¼šå›å¤MsgAppRespæ¶ˆæ¯ã€‚\n  MsgAppResp   ç”¨äºå“åº”logå¤åˆ¶è¯·æ±‚ã€‚å½“MsgAppå‘é€åˆ°candidateå’Œfollowerçš„Stepæ–¹æ³•ï¼Œå®ƒä»¬ä¼šè°ƒç”¨handleAppendEntriesæ–¹æ³•ï¼Œå…¶ä¼šå‘é€MsgAppRespåˆ°raft mailboxã€‚\n  MsgVote   è¯·æ±‚æŠ•ç¥¨é€‰ä¸¾ã€‚å½“MsgHupä¼ é€’åˆ°followeræˆ–candidateçš„Stepæ–¹æ³•ï¼Œå°†ä¼šè°ƒç”¨campaignæ–¹æ³•å»ç«é€‰è‡ªå·±æˆä¸ºleaderï¼Œ ä¸€æ—¦campaignæ–¹æ³•è¢«è°ƒç”¨ï¼ŒèŠ‚ç‚¹å°†ä¼šå˜æˆcandidateï¼Œç„¶åå‘é€MsgVoteåˆ°peerså»è¯·æ±‚æŠ•ç¥¨ã€‚\n å½“æ¶ˆæ¯ä¼ é€’åˆ°leaderæˆ–candidateçš„Stepæ–¹æ³•ï¼Œå¦‚æœæ¶ˆæ¯çš„termå°äºleaderæˆ–candidateçš„termï¼Œåˆ™æ¶ˆæ¯ä¼šè¢«æ‹’ç»æ‰ï¼ˆMsgVoteRespå°†è®¾ç½®Rejectä¸ºtrueï¼‰ï¼Œå¦‚æœleaderæˆ–candidateæ¥æ”¶åˆ°termæ›´å¤§çš„MsgVoteï¼Œä»–ä»¬å°†ä¼šrevert back to followerã€‚ å½“\u0026rsquo;MsgVote\u0026rsquo;è¢«ä¼ é€’ç»™followeræ—¶ï¼Œåªæœ‰å½“senderçš„last termå¤§äºMsgVoteçš„termæˆ–senderçš„last termç­‰äºMsgVoteçš„termä½†senderçš„æœ€åæäº¤ç´¢å¼•å¤§äºæˆ–ç­‰äºfollowerçš„æ—¶ï¼Œå®ƒæ‰ä¼šæŠ•ç¥¨ç»™senderã€‚    MsgVoteResp   æŠ•ç¥¨é€‰ä¸¾ç›¸åº”æ¶ˆæ¯ã€‚å½“candidateæ”¶åˆ°MsgVoteRespï¼Œå®ƒä¼šç»Ÿè®¡è‡ªå·±çš„ç¥¨æ•°ï¼Œå¦‚æœç¥¨æ•°è¶…è¿‡quorumï¼Œå®ƒå°†ä¼šå˜æˆleaderï¼Œç„¶åè°ƒç”¨bcastAppendï¼Œå¦‚æœcandidateæ”¶åˆ°å¤§å¤šæ•°çš„æ‹’ç»æŠ•ç¥¨ï¼Œåˆ™revert back to followerã€‚\n  MsgPreVoteå’ŒMsgPreVoteResp   ä¸¤é˜¶æ®µé€‰ä¸¾åè®®ï¼Œæ˜¯ä¸€ä¸ªå¯é€‰é…ç½®é¡¹ã€‚å½“Config.PreVoteè®¾ç½®ä¸ºtrueæ—¶ï¼Œé¢„é€‰ä¸¾è¿‡ç¨‹ä¸å¸¸è§„é€‰ä¸¾è¿‡ç¨‹ç±»ä¼¼ï¼Œåªæ˜¯ä¸ä¼šå¢åŠ termï¼Œé™¤éå®ƒåœ¨ç¬¬ä¸€ä¸ªé˜¶æ®µç«é€‰èµ¢å¾—äº†å¤§å¤šæ•°ç¥¨ã€‚åŠ å…¥è¿™ä¸ªé€‰é¡¹å¯ä»¥å°†èŠ‚ç‚¹åˆ†åŒºå¯¼è‡´çš„å½±å“é™è‡³æœ€ä½ã€‚\n  MsgSnap   è¯·æ±‚åº”ç”¨å¿«ç…§æ¶ˆæ¯ã€‚å½“ä¸€ä¸ªèŠ‚ç‚¹åˆšå˜ä¸ºleaderï¼Œæˆ–è€…leaderæ¥æ”¶åˆ°MsgPropæ¶ˆæ¯ï¼Œç„¶åè°ƒç”¨bcastAppendæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šè°ƒç”¨sendAppendæ–¹æ³•åˆ°æ¯ä¸ªfollowerèŠ‚ç‚¹ã€‚åœ¨sendAppendæ–¹æ³•ä¸­ï¼Œå¦‚æœleaderè·å–termæˆ–è€…entrieså¤±è´¥ï¼Œåˆ™leaderå°†ä¼šå‘é€MsgSnapç±»å‹æ¶ˆæ¯æ¥è¯·æ±‚å¿«ç…§ã€‚\n  MsgSnapStatus   å‘ŠçŸ¥å¿«ç…§æ¶ˆæ¯åº”ç”¨çš„ç»“æœã€‚å½“followerèŠ‚ç‚¹æ‹’ç»MsgSnapæ¶ˆæ¯ï¼Œè¡¨æ˜å› ä¸ºç½‘ç»œé—®é¢˜å¯¼è‡´ç½‘ç»œå±‚ä¸èƒ½æ­£å¸¸å‘é€snapshotåˆ°followerï¼Œä»è€Œå¯¼è‡´å¿«ç…§è¯·æ±‚å¤±è´¥ï¼Œleaderå°†followerçš„progressè®¾ç½®ä¸ºprobeã€‚å½“MsgSnapæ²¡æœ‰è¢«æ‹’ç»ï¼Œè¡¨æ˜å¿«ç…§è¢«æ­£å¸¸æ¥æ”¶ï¼Œleaderå°†followerçš„progressè®¾ç½®ä¸ºprobeï¼ŒåŒæ—¶å¼€å§‹logå¤åˆ¶ã€‚\n  MsgHeartbeat   leaderå‘é€å¿ƒè·³ä¿¡æ¯ã€‚\n å½“MsgHeartbeatæ¶ˆæ¯å‘é€åˆ°candidateï¼Œä¸”æ¶ˆæ¯çš„termå¤§äºcandidateçš„termï¼Œåˆ™candidateå°†revert back to followerï¼ŒåŒæ—¶ä¼šæ›´æ–°è‡ªå·±çš„æäº¤ç´¢å¼•å·ï¼Œç„¶åå‘é€æ¶ˆæ¯åˆ°mailboxã€‚ å½“MsgHeartbeatæ¶ˆæ¯å‘é€åˆ°followerçš„Stepæ–¹æ³•ï¼Œå¦‚æœæ¶ˆæ¯çš„termå¤§äºfollowerçš„termï¼Œåˆ™followerä¼šæ›´æ–°leaderIDã€‚    MsgHeartbeatResp   å¿ƒè·³å“åº”æ¶ˆæ¯ã€‚MsgHeartbeatRespä¼ é€’åˆ°leaderçš„Stepæ–¹æ³•ï¼Œleaderä¼šçŸ¥é“å“ªäº›èŠ‚ç‚¹åšäº†å›å¤å“åº”ã€‚åªæœ‰å½“leaderæœ€åæäº¤ç´¢å¼•å·å¤§äºfollowerçš„Matchç´¢å¼•å·æ—¶leaderè°ƒç”¨sendAppendæ–¹æ³•ã€‚\n  MsgUnreachable   å‘ŠçŸ¥æ¶ˆæ¯æˆ–è¯·æ±‚ä¸èƒ½è¢«deliverï¼Œå½“MsgUnreachableä¼ é€’åˆ°leaderçš„Stepæ–¹æ³•ï¼Œleaderå‘ç°å‘é€MsgUnreachableæ¶ˆæ¯çš„followerèŠ‚ç‚¹ä¸å¯è¾¾ï¼Œè¿™é€šå¸¸æ„å‘³ç€MsgAppä¸¢å¤±äº†ã€‚å¦‚æœæ­¤æ—¶followerçš„progressçŠ¶æ€ä¸ºreplicateï¼Œåˆ™leaderä¼šå°†å…¶é‡æ–°è®¾ç½®å›probeçŠ¶æ€ã€‚\n  MsgCheckQuorum   å¦‚æœå¼€å¯CheckQuorumï¼Œåˆ™é€‰ä¸¾è¶…æ—¶åä¼šå‘é€MsgCheckQuorumæ¶ˆæ¯ï¼ŒleaderèŠ‚ç‚¹åˆ¤æ–­å…¶æ˜¯å¦æ»¡è¶³quorumï¼Œå¦‚æœä¸æ»¡è¶³åˆ™step down to followerèŠ‚ç‚¹ã€‚\n  MsgReadIndex     MsgReadIndexResp     MsgTransferLeader   å¯¹äºMsgTransferLeaderæ¶ˆæ¯ï¼ŒfollowerèŠ‚ç‚¹ä¼šå°†å…¶è½¬å‘åˆ°leaderèŠ‚ç‚¹ï¼ŒleaderèŠ‚ç‚¹åœ¨æ”¶åˆ°MsgTransferLeaderæ¶ˆæ¯åä¼šé¦–å…ˆè®°å½•leadè¢«è½¬ç§»è€…ï¼Œç„¶ååˆ¤æ–­è½¬ç§»ç›®æ ‡çš„æ—¥å¿—æ˜¯å¦è·Ÿä¸Šäº†ã€‚\n å¦‚æœè·Ÿä¸Šäº†ä¼šå‘è¢«è½¬ç§»è€…å‘é€ MsgTimeoutNow æ¶ˆæ¯, è¢«è½¬ç§»è€…æ”¶åˆ°æ¶ˆæ¯åä¼šå¼ºåˆ¶å‘èµ·æ–°ä¸€è½®é€‰ä¸¾ã€‚ å¦‚æœæ²¡æœ‰è·Ÿä¸Šåˆ™å…ˆè¿›è¡Œæ—¥å¿—åŒæ­¥ï¼Œç­‰leaderæ”¶åˆ°åŒæ­¥æ—¥å¿—çš„MsgAppRespæ¶ˆæ¯åä¼šåˆ¤æ–­å…¶æ˜¯å¦å·²è·Ÿä¸Šï¼Œæ­¥éª¤åŒä¸Šã€‚    MsgTimeoutNow    Local message #   MsgHup MsgBeat MsgUnreachable MsgSnapStatus MsgCheckQuorum  Response message #   MsgAppResp MsgVoteResp MsgHeartbeatResp MsgUnreachable MsgPreVoteResp   Q \u0026amp; A #   å‘é€å¦‚ä¸‹ç±»å‹çš„æ¶ˆæ¯æ—¶éœ€è¦è®¾ç½®termï¼Œå…¶ä»–ç±»å‹çš„æ¶ˆæ¯éƒ½ä¸éœ€è¦è®¾ç½®termã€‚   pb.MsgVote pb.MsgVoteResp pb.MsgPreVote pb.MsgPreVoteResp  ä½†æ˜¯å¯¹äºæ¶ˆæ¯ç±»å‹æ—¢ä¸æ˜¯MsgPropï¼Œåˆä¸æ˜¯MsgReadIndexç±»å‹çš„ï¼Œä¼šä¸ºå…¶åŠ ä¸Šraft.Termï¼Œå…·ä½“å®ç°å‚è€ƒraft/raft.goä¸­çš„ send()æ–¹æ³•ã€‚\nraftçš„tracker.ProgressTrackeråœ¨ä»€ä¹ˆåœ°æ–¹èµ‹å€¼çš„ï¼Ÿ   åˆå§‹åŒ–é›†ç¾¤æ—¶ï¼Œå¦‚æœæ²¡æœ‰WALï¼ŒåŒæ—¶ä¸ºæ–°é›†ç¾¤ï¼ŒåŒæ—¶æŒ‡å®šäº†--initial-clusterå‚æ•°ï¼Œä¼šå°†å…¶è§£æä¸ºServerConfigçš„InitialPeerURLsMapå‚æ•°ï¼Œç„¶ååˆå§‹åŒ–RaftClusterï¼Œå¹¶æ·»åŠ membersã€‚æ¥ç€bootstrapRaftFromClusteræ–¹æ³•ä¼šæ ¹æ®clusterçš„member idsç”Ÿæˆpeersã€‚ Peerçš„ä¿¡æ¯å¦‚ä¸‹ï¼š\n type Peer struct { ID uint64 Context []byte } type Member struct { ID types.ID `json:\u0026#34;id\u0026#34;` RaftAttributes Attributes }  peerä¸­çš„Contextä¸ºMemberåºåˆ—åŒ–åçš„ä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬ ID, RaftAttributes, Attributesä¿¡æ¯ã€‚æ¥ç€raft/node.goä¼šè°ƒç”¨StartNodeæ–¹æ³•ï¼Œé‡Œé¢çš„Bootstrapæ–¹æ³•ä¼šæ ¹æ®peersç”Ÿæˆç›¸åº”çš„pb.ConfChange entriesï¼Œç„¶åè°ƒç”¨applyConfChangeæ–¹æ³•ï¼Œè¿™é‡Œä¼šæ›´æ–°raft.prsï¼Œè¿”å›æœ€æ–°çš„tracker.Configå’Œtracker.ProgressMapä¿¡æ¯ã€‚\n (dlv) p cfg.Voters go.etcd.io/etcd/raft/v3/quorum.JointConfig [ [ 9372538179322589801: {}, 10501334649042878790: {}, 18249187646912138824: {}, ], nil, ] (dlv) p prs go.etcd.io/etcd/raft/v3/tracker.ProgressMap [ 9372538179322589801: *{ Match: 0, Next: 3, State: StateProbe (0), PendingSnapshot: 0, RecentActive: true, ProbeSent: false, Inflights: *(*\u0026#34;go.etcd.io/etcd/raft/v3/tracker.Inflights\u0026#34;)(0xc00012f470), IsLearner: false,}, 10501334649042878790: *{ Match: 0, Next: 3, State: StateProbe (0), PendingSnapshot: 0, RecentActive: true, ProbeSent: false, Inflights: *(*\u0026#34;go.etcd.io/etcd/raft/v3/tracker.Inflights\u0026#34;)(0xc00012f620), IsLearner: false,}, 18249187646912138824: *{ Match: 0, Next: 3, State: StateProbe (0), PendingSnapshot: 0, RecentActive: true, ProbeSent: false, Inflights: *(*\u0026#34;go.etcd.io/etcd/raft/v3/tracker.Inflights\u0026#34;)(0xc00012f560), IsLearner: false,}, ] applyçš„æ—¶å€™ä»€ä¹ˆæ¡ä»¶è§¦å‘å¿«ç…§ï¼Ÿ unstableä¸­çš„å¿«ç…§æ˜¯ä»€ä¹ˆæ—¶å€™èµ‹å€¼çš„ï¼Ÿä»€ä¹ˆæ¡ä»¶è§¦å‘ï¼Ÿ   TODO\n ä¸ºä»€ä¹ˆraft.msgsè¯»å†™æ—¶ä¸éœ€è¦åŠ é”ï¼Ÿ   å…¶å®etcdé‡Œå¾ˆå¤šåœ°æ–¹éƒ½æ˜¯é‡‡ç”¨çš„å•çº¿ç¨‹æ¨¡å¼ï¼Œæ¯”å¦‚applyä¹Ÿæ˜¯ã€‚\n å¯¹äº raftpb.Messageä¸­çš„MsgAppç±»å‹ï¼Œå…¶LogTermï¼ŒIndex, Commit, Entriesçš„å«ä¹‰ï¼Ÿ   LogTermé€šå¸¸ç”¨äºappend raft logsåˆ°followerèŠ‚ç‚¹ã€‚\nä¾‹å¦‚ï¼šå¯¹äºæ¶ˆæ¯(type=MsgApp,index=100,logTerm=5)ï¼Œè¡¨ç¤ºleaderä»index=101å¼€å§‹ append entriesï¼Œè€Œindex=100å¯¹åº”çš„Termå€¼ä¸º5ã€‚ å¯¹äºæ¶ˆæ¯(type=MsgAppResp,reject=true,index=100,logTerm=5)ï¼Œè¡¨ç¤ºfolloweræ‹’ç»äº†leaderçš„entriesï¼ˆå¯èƒ½æ˜¯éƒ¨åˆ†ï¼‰ï¼Œç”±äºfollowerèŠ‚ç‚¹å·²ç»åŒ…å«index=100ï¼Œterm=5çš„entryã€‚\nCommit ä¸º raftLog çš„committed indexã€‚\nIndexå’ŒLogTermå­—æ®µæ˜¯ç”¨äºæ—¥å¿—åŒ¹é…çš„æ—¥å¿—ï¼ˆå³å‘é€çš„æ—¥å¿—çš„ä¸Šä¸€æ¡æ—¥å¿—ï¼‰çš„indexä¸termï¼ˆç”¨äºæ—¥å¿—åŒ¹é…çš„termå­—æ®µä¸ºLogTermï¼Œæ¶ˆæ¯çš„Termå­—æ®µä¸ºè¯¥èŠ‚ç‚¹å½“å‰çš„termï¼Œéƒ¨åˆ†æ¶ˆæ¯éœ€è¦è‡ªå·±æŒ‡å®šï¼Œéƒ¨åˆ†æ¶ˆæ¯ç”±sendæ–¹æ³•å¡«å……ï¼‰ã€‚Entrieså­—æ®µä¿å­˜äº†éœ€è¦å¤åˆ¶çš„æ—¥å¿—æ¡ç›®ã€‚Commitå­—æ®µä¸ºleaderæäº¤çš„æœ€åä¸€æ¡æ—¥å¿—çš„ç´¢å¼•ã€‚\n å¦‚ä½•æé«˜è¯»æ€§èƒ½ï¼ŒåŒæ—¶é¿å…ç½‘ç»œåˆ†åŒºåé‡æ–°é€‰ä¸¾å‡ºæ–°leaderå‡ºç°çš„stale readï¼Ÿ   TODO\n  CheckQuorumé»˜è®¤è‡ªåŠ¨å¼€å¯ï¼ŒåŒæ—¶å¼€å¯Check Quorumä¼šè‡ªåŠ¨å¼€å¯Leader Lease\n  raft.maybeSendAppendåœ¨å‘é€ Message æ—¶ï¼Œä¼šå¯¹ Message ä¸­çš„entrieså¤§å°åšé™åˆ¶ï¼ŒmaxSizePerMsgä¸º1MBï¼Œå› æ­¤entriesåœ¨è¶…è¿‡æ­¤å¤§å°æ—¶ä¼šå¦‚ä½•å¤„ç†ï¼Ÿ raftLog.maybeAppendå¦‚ä½•æ›´æ–°commitï¼Ÿ\n   å¦‚æœè¦å‘é€çš„entriesè¶…è¿‡å¤§å°é™åˆ¶ï¼Œåˆ™ä¼šå‘é€å¤šæ¬¡\n pb.MsgSnapStatusæ¶ˆæ¯ä»¥åŠReportSnapshotçš„ä½œç”¨ï¼Ÿ   TODO\n candidateèŠ‚ç‚¹åœ¨èµ¢å¾—é€‰ä¸¾ä¹‹åä¼šappendä¸€æ¡ç©ºçš„æ—¥å¿—æ¡ç›®ï¼Œå…¶ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ   candidateåœ¨å½“é€‰leaderåä¼šåœ¨å½“å‰termä¸ºè‡ªå·±çš„æ—¥å¿—è¿½åŠ ä¸€æ¡ç©ºæ—¥å¿—æ¡ç›®ï¼Œå¹¶å¹¿æ’­ï¼Œä»¥æäº¤ä¹‹å‰termçš„æ—¥å¿—ï¼Œå…·ä½“å¯å‚è€ƒraft/raft.goä¸­çš„handleAppendEntries()ã€‚\n æ—¥å¿—å¤åˆ¶ä¸åŒ¹é…æ—¶çš„å›é€€ä¼˜åŒ–ç®—æ³•   TODO\n  å¯¹äºfollowerèŠ‚ç‚¹ï¼Œæ— è®ºæ˜¯å¤„ç†MsgAppæ¶ˆæ¯è¿˜æ˜¯å¤„ç†MsgSnapæ¶ˆæ¯ï¼Œè¿”å›çš„æ¶ˆæ¯éƒ½æ˜¯MsgAppRespã€‚\n  åœ¨é€šè¿‡Transportå‘é€Messagesæ—¶ï¼Œä¼šå¿½ç•¥Message.To == 0çš„æ¶ˆæ¯ã€‚\n  ç”±äºetcdçš„æ¨¡å—åŒ–è®¾è®¡ï¼Œraftæ¨¡å—å’Œå­˜å‚¨ç½‘ç»œæ¨¡å—æ˜¯åˆ†å¼€çš„ï¼Œå› æ­¤sendæ–¹æ³•åªæ˜¯å°†æ¶ˆæ¯æ”¾å…¥mailboxï¼Œè€Œä¸æ˜¯ç«‹åˆ»å°†å…¶å‘å‡ºï¼ˆetcd/raftä¹Ÿæ²¡æœ‰é€šä¿¡æ¨¡å—ï¼‰, å…¶ä¸å¤–ç•Œçš„äº¤äº’éƒ½æ˜¯é€šè¿‡Readyæ¥è¿›è¡Œå¤„ç†çš„ã€‚å› æ­¤ï¼Œå½“followeræ”¶åˆ°MsgAppè¯·æ±‚æ—¶ï¼Œæ‰§è¡Œçš„æ“ä½œå®é™…ä¸Šæ˜¯ï¼ˆä¸è€ƒè™‘ç‰¹æ®Šæƒ…å†µï¼‰ï¼š\n    å°†æ–°æ—¥å¿—è¿½åŠ åˆ°unstableä¸­ã€‚ å°†åŒ…å«unstableçš„last indexçš„MsgAppRespæ¶ˆæ¯æ”¾å…¥ä¿¡ç®±ï¼Œç­‰å¾…å‘é€ã€‚   å¯¹äºReadyçš„å¤„ç†ï¼Œè§’è‰²ä¸åŒå¤„ç†çš„æ¬¡åºä¹Ÿæ˜¯æœ‰åŒºåˆ«çš„ï¼š\n  å¯¹äº follower èŠ‚ç‚¹ï¼Œæ˜¯å…ˆå°† entriesï¼Œ hardStateï¼Œ snapshot ä¿å­˜åˆ°ç¨³å®šçš„å­˜å‚¨åå†å‘é€ Messagesã€‚ å¯¹äº leader èŠ‚ç‚¹ï¼Œå¯ä»¥åœ¨å‘é€ Messages çš„åŒæ—¶å°† entriesï¼Œ hardStateï¼Œ snapshotæŒä¹…åŒ–ã€‚   raftä¸­çš„å¼‚å¸¸å¤„ç†ï¼Œä¾‹å¦‚ æ·»åŠ æˆå‘˜æ—¶leaderæ­£åœ¨è¿›è¡ŒleadTransferï¼Œå¦‚æœæ”¶åˆ°MsgPropçš„æ¶ˆæ¯ï¼Œè¿™æ—¶ä¼šè¿”å› ErrProposalDropped å¦‚ä½•å¤„ç†ï¼Ÿ   TODO\n applyEntryNormalæ—¶æœ‰V2å’ŒV3è¯·æ±‚ï¼Œåˆ†åˆ«å¯¹åº”pb.Requestå’Œpb.InternalRaftRequestï¼Œå…¶logå¯¹åº”ï¼š  167 {\u0026quot;level\u0026quot;:\u0026quot;debug\u0026quot;,\u0026quot;ts\u0026quot;:\u0026quot;2021-12-08T10:49:48.188+0800\u0026quot;,\u0026quot;caller\u0026quot;:\u0026quot;etcdserver/server.go:1835\u0026quot;,\u0026quot;msg\u0026quot;:\u0026quot;Applying entry\u0026quot;,\u0026quot;index\u0026quot;:8,\u0026quot;term\u0026quot;:2,\u0026quot;type\u0026quot;:\u0026quot;EntryNormal\u0026quot;} 168 {\u0026quot;level\u0026quot;:\u0026quot;debug\u0026quot;,\u0026quot;ts\u0026quot;:\u0026quot;2021-12-08T10:49:48.189+0800\u0026quot;,\u0026quot;caller\u0026quot;:\u0026quot;etcdserver/server.go:1885\u0026quot;,\u0026quot;msg\u0026quot;:\u0026quot;apply entry normal\u0026quot;,\u0026quot;consistent-index\u0026quot;:7,\u0026quot;entry-index\u0026quot;:8,\u0026quot;should-applyV3\u0026quot;:true} 169 {\u0026quot;level\u0026quot;:\u0026quot;debug\u0026quot;,\u0026quot;ts\u0026quot;:\u0026quot;2021-12-08T10:49:48.189+0800\u0026quot;,\u0026quot;caller\u0026quot;:\u0026quot;etcdserver/server.go:1908\u0026quot;,\u0026quot;msg\u0026quot;:\u0026quot;applyEntryNormal\u0026quot;,\u0026quot;V2request\u0026quot;:\u0026quot;ID:16732981032079369986 Method:\\\u0026quot;PUT\\\u0026quot; Path:\\\u0026quot;/0/members/45d559f8148de837/attributes\\\u0026quot; Val:\\\u0026quot;{\\\\\\\u0026quot;name\\\\\\\u0026quot;:\\\\\\\u0026quot;infra4\\\\\\\u0026quot;,\\\\\\\u0026quot;clientURLs\\\\\\\u0026quot;:[\\\\\\\u0026quot;http://127.0.0.1:42379\\\\\\\u0026quot;]}\\\u0026quot; \u0026quot;} 206 {\u0026quot;level\u0026quot;:\u0026quot;debug\u0026quot;,\u0026quot;ts\u0026quot;:\u0026quot;2021-12-08T10:49:48.206+0800\u0026quot;,\u0026quot;caller\u0026quot;:\u0026quot;etcdserver/server.go:1835\u0026quot;,\u0026quot;msg\u0026quot;:\u0026quot;Applying entry\u0026quot;,\u0026quot;index\u0026quot;:12,\u0026quot;term\u0026quot;:2,\u0026quot;type\u0026quot;:\u0026quot;EntryNormal\u0026quot;} 207 {\u0026quot;level\u0026quot;:\u0026quot;debug\u0026quot;,\u0026quot;ts\u0026quot;:\u0026quot;2021-12-08T10:49:48.206+0800\u0026quot;,\u0026quot;caller\u0026quot;:\u0026quot;etcdserver/server.go:1885\u0026quot;,\u0026quot;msg\u0026quot;:\u0026quot;apply entry normal\u0026quot;,\u0026quot;consistent-index\u0026quot;:11,\u0026quot;entry-index\u0026quot;:12,\u0026quot;should-applyV3\u0026quot;:true} 208 {\u0026quot;level\u0026quot;:\u0026quot;debug\u0026quot;,\u0026quot;ts\u0026quot;:\u0026quot;2021-12-08T10:49:48.206+0800\u0026quot;,\u0026quot;caller\u0026quot;:\u0026quot;etcdserver/server.go:1912\u0026quot;,\u0026quot;msg\u0026quot;:\u0026quot;applyEntryNormal\u0026quot;,\u0026quot;raftReq\u0026quot;:\u0026quot;header:\u0026lt;ID:13926956989250840580 \u0026gt; cluster_version_set:\u0026lt;ver:\\\u0026quot;3.6.0\\\u0026quot; \u0026gt; \u0026quot;} 261 {\u0026quot;level\u0026quot;:\u0026quot;debug\u0026quot;,\u0026quot;ts\u0026quot;:\u0026quot;2021-12-08T10:52:35.450+0800\u0026quot;,\u0026quot;caller\u0026quot;:\u0026quot;etcdserver/server.go:1835\u0026quot;,\u0026quot;msg\u0026quot;:\u0026quot;Applying entry\u0026quot;,\u0026quot;index\u0026quot;:14,\u0026quot;term\u0026quot;:2,\u0026quot;type\u0026quot;:\u0026quot;EntryNormal\u0026quot;} 262 {\u0026quot;level\u0026quot;:\u0026quot;debug\u0026quot;,\u0026quot;ts\u0026quot;:\u0026quot;2021-12-08T10:52:35.450+0800\u0026quot;,\u0026quot;caller\u0026quot;:\u0026quot;etcdserver/server.go:1885\u0026quot;,\u0026quot;msg\u0026quot;:\u0026quot;apply entry normal\u0026quot;,\u0026quot;consistent-index\u0026quot;:13,\u0026quot;entry-index\u0026quot;:14,\u0026quot;should-applyV3\u0026quot;:true} 263 {\u0026quot;level\u0026quot;:\u0026quot;debug\u0026quot;,\u0026quot;ts\u0026quot;:\u0026quot;2021-12-08T10:52:35.450+0800\u0026quot;,\u0026quot;caller\u0026quot;:\u0026quot;etcdserver/server.go:1912\u0026quot;,\u0026quot;msg\u0026quot;:\u0026quot;applyEntryNormal\u0026quot;,\u0026quot;raftReq\u0026quot;:\u0026quot;header:\u0026lt;ID:3632572666012018439 \u0026gt; put:\u0026lt;key:\\\u0026quot;\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\\000\\\u0026quot; value:\\\u0026quot;\\\\026T\\\\316d\\\\230x\\\\326x\\\u0026quot; \u0026gt; \u0026quot;} æ–°åŠ å…¥çš„èŠ‚ç‚¹æˆ–è€…è½åå¾ˆå¤šçš„èŠ‚ç‚¹ï¼Œleader ä¼šå°è¯•å‘é€å¿«ç…§æ•°æ®ç»™followerèŠ‚ç‚¹ï¼ŒmaybeSendAppendæ–¹æ³•åœ¨å¤„ç†æ—¶ä¼šç”Ÿæˆå¿«ç…§æ¶ˆæ¯ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š  snapshot, _ := r.raftLog.snapshot() pb.Message{ To: to, Type: pb.MsgSnap, Snapshot: snapshot, // çœ‹èµ·æ¥æœ‰ç‚¹å¤šä½™ } åº”ç”¨é€»è¾‘å±‚é€šè¿‡Readyè·å–messagesä¹‹åä¼šå°†å¿«ç…§æ¶ˆæ¯å•ç‹¬å¤„ç†ï¼ˆå°†å…¶å‘é€åˆ°msgSnapCï¼‰ï¼ŒapplyAll åœ¨æ”¶åˆ°å¿«ç…§æ¶ˆæ¯åä¼šè°ƒç”¨ createMergedSnapshotMessage ç”Ÿæˆåˆå¹¶çš„snap.Messageæ¶ˆæ¯åå°†å…¶å‘é€åˆ°peerç«¯ã€‚è€Œ createMergedSnapshotMessage æ–¹æ³•ä¼šæ ¹æ®å½“å‰ etcd progress çš„ appliedtå’Œappliedié‡æ–°ç”Ÿæˆæ–°çš„ Metadata å’Œ Data (v2 storeåºåˆ—åŒ–åçš„æ•°æ®)ï¼Œæ‰€ä»¥ä¸Šé¢raftå±‚åœ¨ç”Ÿæˆ MsgSnap æ¶ˆæ¯æ—¶çš„ Snapshot æ˜¯å¤šä½™çš„ï¼Œè™½ç„¶ä¸å½±å“ã€‚\nserializable read request å’Œ linearizable read request ?   Linearizability is one of the strongest single-object consistency models, and implies that every operation appears to take place atomically, in some order, consistent with the real-time ordering of those operations: e.g., if operation A completes before operation B begins, then B should logically take effect after A.\n  etcd ä¸­é»˜è®¤æ˜¯linearizable readï¼Œå¦‚æœéœ€è¦å®¢æˆ·ç«¯serializable readï¼Œå¯ä»¥é€šè¿‡WithSerializable()è¿›è¡Œè®¾ç½®ï¼ŒSerializable è¯·æ±‚é€‚ç”¨äºä½å»¶è¿Ÿã€‚\n ä»¥Rangeä¸ºä¾‹ï¼Œ\nif !r.Serializable { err = s.linearizableReadNotify(ctx) trace.Step(\u0026#34;agreement among raft nodes before linearized reading\u0026#34;) if err != nil { return nil, err } } ReadOnlyOption åŒ…å«ä¸¤ç§ç±»å‹ï¼š\n ReadOnlySafe é€šè¿‡ä¸quorumä¸ªèŠ‚ç‚¹è¿›è¡Œé€šä¿¡æ¥ä¿è¯åªè¯»è¯·æ±‚çš„çº¿æ€§åŒ–ï¼Œé»˜è®¤é€‰é¡¹ã€‚ ReadOnlyLeaseBased ä¾èµ–é¢†å¯¼è€…ç§Ÿçº¦(leader lease)æ¥ä¿è¯åªè¯»è¯·æ±‚çš„çº¿æ€§åŒ–ï¼Œå®ƒä¼šå—clock driftçš„å½±å“ã€‚  å¦‚æœReadOnlyOption æ˜¯ ReadOnlyLeaseBased çš„æ—¶å€™å¿…é¡»å¼€å¯CheckQuorumã€‚\n Read index retry ä¸­æœ‰ä¸ªæ³¨é‡Šè¿˜æ²¡å¤ªç†è§£\n    codes\nserver/etcdserver/server.go 299 NewServer() server/etcdserver/bootstrap.go 526 newRaftNode() server/etcdserver/bootstrap.go 268 bootstrapCluster() server/etcdserver/api/rafthttp/transport.go 175 Send() raft/node.go 241 RestartNode() Breakpoint 1 (enabled) at 0xfc67f5 for go.etcd.io/etcd/server/v3/etcdserver.NewServer() ./server/etcdserver/server.go:300 (1) Breakpoint 2 (enabled) at 0xfad002 for go.etcd.io/etcd/server/v3/etcdserver.bootstrapCluster() ./server/etcdserver/bootstrap.go:269 (1) ConfState #  raft/tracker/tracker.go 146 ConfState() server/storage/schema/confstate.go åœ¨DBä¸­ä¿å­˜æˆ–è€…è¯»å– raft/confchange/restore.go raft/raft.go server/etcdserver/bootstrap.go 285 bootstrapExistingClusterNoWAL() raft/raft.go stepLeader() 1112 raft/raft.go maybeSendAppend() 432 raft/raft.go handleAppendEntries() 1498 snapshot å‘é€ä¸æ¥æ”¶ #  server/etcdserver/api/rafthttp/http.go 199 ServeHTTP() server/etcdserver/snapshot_merge.go server/etcdserver/server.go 906 applyAll() server/etcdserver/api/rafthttp/snapshot_sender.go 68 send() server/etcdserver/raft.go 246 start() å‚è€ƒé“¾æ¥ #   etcd æ³¨è§£ç‰ˆ raft doc etcdçš„raftå®ç°ä¹‹tracker\u0026amp;quorum etcd raft å¤„ç†æµç¨‹å›¾ç³»åˆ—3-walçš„å­˜å‚¨å’Œè¿è¡Œ æ·±å…¥æµ…å‡ºetcd/raft â€”â€” 0x05 Raftæˆå‘˜å˜æ›´ raft: liveness problems during apply-time configuration change etcd learner design raft: implement fast log rejection Raft Consensus Protocol Made Simpler  "},{"id":1,"href":"/posts/prometheus-wal/","title":"Prometheus WALæºç é˜…è¯»","section":"Blog","content":" æ¦‚è¿° #  WAL(Write-ahead logging, é¢„å†™æ—¥å¿—)æ˜¯å…³ç³»å‹æ•°æ®åº“ä¸­åˆ©ç”¨æ—¥å¿—æ¥å®ç°äº‹åŠ¡æ€§å’ŒæŒä¹…æ€§çš„ä¸€ç§æŠ€æœ¯ï¼Œå³åœ¨æŸä¸ªæ“ä½œä¹‹å‰å…ˆå°†è¿™ä¸ªäº‹æƒ…è®°å½•ä¸‹æ¥ï¼Œä»¥ä¾¿ä¹‹åå¯¹æ•°æ®è¿›è¡Œå›æ»šï¼Œé‡è¯•ç­‰æ“ä½œä¿è¯æ•°æ®çš„å¯é æ€§ã€‚\nPrometheusä¸ºäº†é˜²æ­¢ä¸¢å¤±æš‚å­˜åœ¨å†…å­˜ä¸­çš„è¿˜æœªè¢«å†™å…¥ç£ç›˜çš„ç›‘æ§æ•°æ®ï¼Œå¼•å…¥äº†WALæœºåˆ¶ã€‚WALè¢«åˆ†å‰²æˆé»˜è®¤å¤§å°ä¸º128Mçš„æ–‡ä»¶æ®µï¼ˆsegmentï¼‰ï¼Œä¹‹å‰ç‰ˆæœ¬é»˜è®¤å¤§å°æ˜¯256Mï¼Œæ–‡ä»¶æ®µä»¥æ•°å­—å‘½åï¼Œé•¿åº¦ä¸º8ä½çš„æ•´å½¢ã€‚WALçš„å†™å…¥å•ä½æ˜¯é¡µï¼ˆpageï¼‰ï¼Œæ¯é¡µçš„å¤§å°ä¸º32KBï¼Œæ‰€ä»¥æ¯ä¸ªæ®µå¤§å°å¿…é¡»æ˜¯é¡µçš„å¤§å°çš„æ•´æ•°å€ã€‚æ¯ä¸ªæ–‡ä»¶æ®µéƒ½æœ‰ä¸€ä¸ªâ€œ==å·²ä½¿ç”¨çš„é¡µï¼Ÿ==â€å±æ€§æ¥æ ‡è¯†åœ¨è¯¥æ®µä¸­å·²ç»åˆ†é…çš„é¡µæ•°ç›®ï¼Œå¦‚æœWALä¸€æ¬¡æ€§å†™å…¥çš„é¡µæ•°è¶…è¿‡ä¸€ä¸ªæ®µçš„ç©ºé—²é¡µæ•°ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ–‡ä»¶æ®µæ¥ä¿å­˜è¿™äº›é¡µï¼Œä»è€Œç¡®ä¿ä¸€æ¬¡æ€§å†™å…¥çš„é¡µä¸ä¼šè·¨æ®µå­˜å‚¨ã€‚\nconst ( DefaultSegmentSize = 128 * 1024 * 1024 // 128 MB  pageSize = 32 * 1024 // 32KB  recordHeaderSize = 7 ) æœ¬æ–‡æ˜¯åœ¨prometheus tsdbéƒ¨åˆ†æºç é˜…è¯»ä¹‹wal.LogSeriesåŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•ï¼Œç”±äºtsdb/wal.goæ–‡ä»¶ä¸­å®šä¹‰çš„WALæ¥å£ä»¥åŠç›¸å…³æ–¹æ³•å·²ç»deprecatedï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚å› æ­¤æœ¬æ–‡é’ˆå¯¹tsdb/wal/wal.goæ–‡ä»¶è¿›è¡Œåˆ†æã€‚\n// WAL is a write ahead log that can log new series labels and samples. // It must be completely read before new entries are logged. // // DEPRECATED: use wal pkg combined with the record codex instead. type WAL interface { Reader() WALReader LogSeries([]RefSeries) error LogSamples([]RefSample) error LogDeletes([]Stone) error Truncate(mint int64, keep func(uint64) bool) error Close() error }  Prometheus storage hierarchy #  (ENV) ğŸº /Users/xsky/go/src/github.com/microyahoo/prometheus/data â˜ tree -h . â”œâ”€â”€ [ 192] 01DPE8T5XPQ9ZYHSNJYBJBKGR6 â”‚Â â”œâ”€â”€ [ 96] chunks â”‚Â â”‚Â â””â”€â”€ [7.1K] 000001 â”‚Â â”œâ”€â”€ [ 22K] index â”‚Â â”œâ”€â”€ [ 272] meta.json â”‚Â â””â”€â”€ [ 9] tombstones â”œâ”€â”€ [ 0] lock â”œâ”€â”€ [ 20K] queries.active â””â”€â”€ [ 256] wal â”œâ”€â”€ [ 0] 00000050 â”œâ”€â”€ [ 0] 00000051 â”œâ”€â”€ [ 0] 00000052 â”œâ”€â”€ [ 0] 00000053 â”œâ”€â”€ [ 10K] 00000054 â””â”€â”€ [ 96] checkpoint.000049 â””â”€â”€ [ 32K] 00000000 4 directories, 12 files ä»ä¸Šé¢ç›®å½•ç»“æ„å¯ä»¥çœ‹å‡ºwalä¸»è¦åŒ…å«segmentæ–‡ä»¶ï¼Œcheckpointç›®å½•ã€‚\n// WAL is a write ahead log that stores records in segment files. // It must be read from start to end once before logging new data. // If an error occurs during read, the repair procedure must be called // before it\u0026#39;s safe to do further writes. // // Segments are written to in pages of 32KB, with records possibly split // across page boundaries. // Records are never split across segments to allow full segments to be // safely truncated. It also ensures that torn writes never corrupt records // beyond the most recent segment. type WAL struct { dir string logger log.Logger segmentSize int mtx sync.RWMutex segment *Segment // Active segment.  donePages int // Pages written to the segment.  page *page // Active page.  stopc chan chan struct{} actorc chan func() closed bool // To allow calling Close() more than once without blocking.  compress bool snappyBuf []byte fsyncDuration prometheus.Summary pageFlushes prometheus.Counter pageCompletions prometheus.Counter truncateFail prometheus.Counter truncateTotal prometheus.Counter currentSegment prometheus.Gauge } // Segment represents a segment file. type Segment struct { *os.File dir string i int }  Create Segment #  åˆ›å»ºsegmentä¸»è¦æ˜¯é€šè¿‡Newæ–¹æ³•æˆ–è€…NewSizeæ–¹æ³•ã€‚å…¶ä¸­NewSizeå¯ä»¥æŒ‡å®šsegmentçš„å¤§å°ï¼ŒNewæ–¹æ³•ä¼ å…¥çš„æ˜¯é»˜è®¤çš„segmentå¤§å°ï¼Œå³128Mã€‚åŠ è½½DBæ—¶å¦‚æœWAL enabledçš„è¯ï¼Œåˆ™ä¼šè°ƒç”¨NewSizeåˆ›å»ºæ–°çš„segmentï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚ä¸‹é¢å¯¹NewSizeè¿›è¡Œå±•å¼€ã€‚\nwlog, err = wal.NewSize(l, r, filepath.Join(dir, \u0026quot;wal\u0026quot;), segmentSize, opts.WALCompression)  é¦–å…ˆåˆ¤æ–­æ®µå¤§å°æ˜¯å¦æ˜¯pageçš„æ•´æ•°å€ã€‚ å¦‚æœwalç›®å½•ä¸å­˜åœ¨çš„è¯åˆ™åˆ›å»ºwalç›®å½•ã€‚ åˆ›å»ºWALæ•°æ®ç»“æ„ã€‚å› ä¸ºWALæ˜¯ä¸active segmentå…³è”çš„ï¼Œæ‰€ä»¥WAL segmentSizeå³ä¸ºæŒ‡å®šçš„segmentSizeã€‚ æŸ¥æ‰¾ç›®å‰WALä¸­æ‰€æœ‰çš„segmentè®°å½•ã€‚å› ä¸ºsegmentæ˜¯æŒ‰ç…§æ•°å­—å‘½åå¹¶é€’å¢çš„ï¼Œæ‰€ä»¥å…¶åå­—å³ä¸ºç´¢å¼•ï¼Œå…¶å†…éƒ¨è¡¨è¿°ä¸ºsegmentRefï¼Œnameä¸ºå…¶æ–‡ä»¶åï¼Œå³å‰ç¼€ä¸º0å¡«å……çš„å…«ä½æ•´å½¢è¡¨ç¤ºï¼Œindexå³ä¸ºå…¶æ•´å½¢è¡¨ç¤ºã€‚  type segmentRef struct { name string index int }  ä¸Šé¢æ­¥éª¤è·å–åˆ°last segmentä¹‹åï¼Œä¸‹ä¸€ä¸ªè¦å†™å…¥çš„segment indexå³ä¸ºlast+1ï¼Œåˆ›å»ºæ–°çš„segmentã€‚ å°†æ–°åˆ›å»ºçš„segmentè®¾ç½®ä¸ºWALçš„active segmentï¼ŒåŒæ—¶æ ¹æ®segmentæ–‡ä»¶å¤§å°è®¾ç½®WAL donePagesï¼Œå°†WAL currentSegmentè®¾ç½®ä¸ºæ–°åˆ›å»ºçš„segmentçš„indexã€‚ å¯åŠ¨æ–°çš„goroutineæ‰§è¡Œactorcé€šé“å‘é€è¿‡æ¥çš„funcã€‚ä¸»è¦ç”¨äºæ‰§è¡Œæ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œä¾‹å¦‚å°†segmentä¸­çš„æ•°æ®fsyncåˆ°diskä¸­ã€‚   WAL Repair #   Repair attempts to repair the WAL based on the error. It discards all data after the corruption.\n éœ€è¦æ³¨æ„çš„æ˜¯Repairä»…èƒ½ä¿®å¤CorruptionErrã€‚CorruptionErrä¸­æŒ‡å®šäº†ç›®å½•ï¼Œæ®µï¼Œåç§»é‡ä»¥åŠå…·ä½“çš„é”™è¯¯ä¿¡æ¯ã€‚\n// CorruptionErr is an error that\u0026#39;s returned when corruption is encountered. type CorruptionErr struct { Dir string Segment int Offset int64 Err error }  é¦–å…ˆè·å–walç›®å½•ä¸­æ‰€æœ‰çš„segmentsã€‚ åˆ é™¤CorruptionErr.Segmentç´¢å¼•ä¹‹åçš„æ‰€æœ‰çš„segmentsã€‚ å…³é—­WALçš„active segmentã€‚ å°†CorruptionErr.Segmentç´¢å¼•çš„segmentåŠ ä¸Š.repairåç¼€å¹¶é‡å‘½åã€‚ åˆ›å»ºä¸€ä¸ªæ–°çš„segmentæ–‡ä»¶ï¼Œå…¶indexä¸ºCorruptionErr.Segmentï¼Œå³Corruption segmenté‡å‘½åä¹‹åé‡æ–°åˆ›å»ºä¸€ä¸ªæ–°çš„segmentæ–‡ä»¶ï¼Œå¹¶å°†WALçš„active segmentæŒ‡å‘æ–°åˆ›å»ºçš„segmentã€‚ å°†Corruption segmentä¸­çš„æ•°æ®è¯»åˆ°æ–°åˆ›å»ºçš„segmentæ–‡ä»¶ä¸­ï¼Œè¯»åˆ°CorruptionErr.Offsetä¸ºæ­¢ã€‚  éå†è¯»å–corrupted segmentä¸­çš„recordsï¼Œå°†å…¶å†™å…¥new segmentä¸­ã€‚   å°†active pageåˆ·å…¥fileã€‚ å…³é—­corrupted segmentæ–‡ä»¶ï¼Œå¹¶åˆ é™¤ã€‚ åˆ›å»ºä¸€ä¸ªæ–°çš„segmentæ–‡ä»¶ï¼Œå…¶indexä¸ºCorruptionErr.Segmentçš„index+1ï¼Œå¹¶å°†active segmentæŒ‡å‘æ–°åˆ›å»ºçš„segmentã€‚  ä¸‹é¢æˆªå–tsdb/wal/wal.goæ–‡ä»¶ä¸­çš„éƒ¨åˆ†Repairçš„ä»£ç è¿›è¡Œåˆ†æã€‚\n// æ‰“å¼€corrupted segmentæ–‡ä»¶å¹¶è¯»å–å…¶ä¸­çš„recordsã€‚  r := NewReader(bufio.NewReader(f)) // ä¸‹é¢WAL Readeréƒ¨åˆ†æœ‰è¯¦ç»†è§£é‡Š  for r.Next() { // Add records only up to the where the error was.  // è¯»å–åˆ°å‡ºé”™çš„åœ°æ–¹ä¸ºæ­¢ã€‚  if r.Offset() \u0026gt;= cerr.Offset { break } // ä¸‹é¢ç€é‡ä»‹ç»æ­¤æ–¹æ³•  if err := w.Log(r.Record()); err != nil { return errors.Wrap(err, \u0026#34;insert record\u0026#34;) } } // We expect an error here from r.Err(), so nothing to handle.  // We need to pad to the end of the last page in the repaired segment  if err := w.flushPage(true); err != nil { return errors.Wrap(err, \u0026#34;flush page in repair\u0026#34;) } // We explicitly close even when there is a defer for Windows to be  // able to delete it. The defer is in place to close it in-case there  // are errors above.  if err := f.Close(); err != nil { return errors.Wrap(err, \u0026#34;close corrupted file\u0026#34;) } // åˆ é™¤.repairæ–‡ä»¶  if err := os.Remove(tmpfn); err != nil { return errors.Wrap(err, \u0026#34;delete corrupted segment\u0026#34;) } // Explicitly close the segment we just repaired to avoid issues with Windows.  s.Close() // We always want to start writing to a new Segment rather than an existing  // Segment, which is handled by NewSize, but earlier in Repair we\u0026#39;re deleting  // all segments that come after the corrupted Segment. Recreate a new Segment here.  // åˆ›å»ºæ–°çš„segment fileï¼Œå¹¶å°†active segmentæŒ‡å‘æ­¤æ–°åˆ›å»ºçš„segment file  s, err = CreateSegment(w.dir, cerr.Segment+1) if err != nil { return err } if err := w.setSegment(s); err != nil { return err } return nil Repairçš„æ ¸å¿ƒå°±æ˜¯å°†corrupted segmentæ–‡ä»¶ä¸­çš„æ•°æ®å†™å…¥æ–°çš„segmentä¸­ï¼Œç„¶ååˆ é™¤corrupted segmentæ–‡ä»¶ã€‚ä¸‹é¢ç€é‡ä»‹ç»å…¶å†™å…¥è¿‡ç¨‹ï¼Œä¸»è¦æ˜¯è°ƒç”¨WALçš„logæ–¹æ³•ã€‚\n// log writes rec to the log and forces a flush of the current page if: // - the final record of a batch // - the record is bigger than the page size // - the current page is full. func (w *WAL) log(rec []byte, final bool) error { // When the last page flush failed the page will remain full.  // When the page is full, need to flush it before trying to add more records to it.  // å¦‚æœWALçš„active pageå·²æ»¡ï¼Œåˆ™flushåˆ°fileï¼Œå¹¶é‡ç½®æ­¤page  if w.page.full() { if err := w.flushPage(true); err != nil { return err } } // If the record is too big to fit within the active page in the current  // segment, terminate the active segment and advance to the next one.  // This ensures that records do not cross segment boundaries.  left := w.page.remaining() - recordHeaderSize // Free space in the active page.  left += (pageSize - recordHeaderSize) * (w.pagesPerSegment() - w.donePages - 1) // Free pages in the active segment.  // å¦‚æœrecordçš„é•¿åº¦å¤§äºactive segmentçš„å‰©ä½™å¯ç”¨ç©ºé—´ï¼Œåˆ™åˆ›å»ºæ–°çš„segment  if len(rec) \u0026gt; left { // 1. å¦‚æœactive pageå·²åˆ†é…å¤§å°ä¸ä¸º0ï¼Œåˆ™flush pageåˆ°fileã€‚  // 2. åˆ›å»ºæ–°çš„segment fileã€‚  // 3. å°†ä¸Šä¸€ä¸ªsegment fileçš„æ•°æ®fsyncåˆ°ç£ç›˜ã€‚  if err := w.nextSegment(); err != nil { return err } } compressed := false if w.compress \u0026amp;\u0026amp; len(rec) \u0026gt; 0 { // The snappy library uses `len` to calculate if we need a new buffer.  // In order to allocate as few buffers as possible make the length  // equal to the capacity.  // å¦‚æœWAL compress enabledï¼Œåˆ™å°†recordæ•°æ®ç¼–ç ä¸ºsnappyBufï¼Œ  // å°†recæŒ‡å‘å‹ç¼©åçš„snappyBufæ•°æ®è®°å½•ã€‚  w.snappyBuf = w.snappyBuf[:cap(w.snappyBuf)] w.snappyBuf = snappy.Encode(w.snappyBuf, rec) if len(w.snappyBuf) \u0026lt; len(rec) { rec = w.snappyBuf compressed = true } } // Populate as many pages as necessary to fit the record.  // Be careful to always do one pass to ensure we write zero-length records.  for i := 0; i == 0 || len(rec) \u0026gt; 0; i++ { p := w.page // Find how much of the record we can fit into the page.  var ( l = min(len(rec), (pageSize-p.alloc)-recordHeaderSize) part = rec[:l] // bufæŒ‡å‘page.bufçš„offsetä¸ºpage.alloc  buf = p.buf[p.alloc:] typ recType ) switch { case i == 0 \u0026amp;\u0026amp; len(part) == len(rec): typ = recFull case len(part) == len(rec): typ = recLast case i == 0: typ = recFirst default: typ = recMiddle } if compressed { typ |= snappyMask } // åˆ¤æ–­recordçš„typeå’Œæ˜¯å¦compressï¼Œå¹¶å°†å…¶å†™å…¥bufçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ã€‚  // æ¥ç€å†™å…¥2å­—èŠ‚çš„é•¿åº¦ä¸ºmin(len(record), (pageSize-p.alloc)-recordHeaderSize)ï¼Œ  // ä¹Ÿå°±æ˜¯è¯´æœ‰å¯èƒ½recordçš„é•¿åº¦å¤§äºactive pageæ‰€èƒ½åˆ†é…çš„æœ€å¤§é•¿åº¦ï¼Œ  // è¿™æ ·recordå°±ä¼šè·¨pageï¼Œä½†æ˜¯ä¸èƒ½è·¨segmentã€‚  // ç„¶åå†™å…¥4ä¸ªå­—èŠ‚çš„CRC  buf[0] = byte(typ) crc := crc32.Checksum(part, castagnoliTable) binary.BigEndian.PutUint16(buf[1:], uint16(len(part))) binary.BigEndian.PutUint32(buf[3:], crc) // ç´§æ¥ç€headerå†™å…¥recordæ•°æ®è®°å½•ï¼Œå¯èƒ½æ˜¯ä¸€éƒ¨åˆ†ã€‚  copy(buf[recordHeaderSize:], part) p.alloc += len(part) + recordHeaderSize // å¦‚æœpageå·²æ»¡ï¼Œåˆ™flushåˆ°fileä¸­ã€‚  if w.page.full() { if err := w.flushPage(true); err != nil { return err } } rec = rec[l:] } // If it\u0026#39;s the final record of the batch and the page is not empty, flush it.  if final \u0026amp;\u0026amp; w.page.alloc \u0026gt; 0 { if err := w.flushPage(false); err != nil { return err } } return nil } WAL Reader #  // Reader reads WAL records from an io.Reader. type Reader struct { rdr io.Reader err error rec []byte snappyBuf []byte buf [pageSize]byte total int64 // Total bytes processed.  curRecTyp recType // Used for checking that the last record is not torn. } å…¶ä¸­Readerä»rdrä¸­è¯»å–recordsï¼Œç›¸å½“äºæŠŠio.Readeråšäº†ä¸€å±‚åŒ…è£…ï¼›bufä¸ºå¤§å°ä¸ºpageSizeçš„å­—èŠ‚æ•°ç»„ã€‚\n+--------------------------------------------------+ | Reader.buf | +-----------------------------------+--------------+ | hdr | buf | +-----------+----------+------------+--------------+ | type \u0026lt;1b\u0026gt; | len \u0026lt;2b\u0026gt; | CRC32 \u0026lt;4b\u0026gt; | data \u0026lt;bytes\u0026gt; | +-----------+----------+------------+--------------+ the record fragment is encoded as:\n+-----------+----------+------------+--------------+ | type \u0026lt;1b\u0026gt; | len \u0026lt;2b\u0026gt; | CRC32 \u0026lt;4b\u0026gt; | data \u0026lt;bytes\u0026gt; | +-----------+----------+------------+--------------+ The type flag has the following states:\n 0: rest of page will be empty 1: a full record encoded in a single fragment 2: first fragment of a record 3: middle fragment of a record 4: final fragment of a record  å…¶ä¸­typeå ç”¨ä¸€ä¸ªbyteï¼Œç”±äºtype flagåªæœ‰äº”ç§çŠ¶æ€ï¼Œ3 bitså°±å¯ä»¥è¡¨ç¤ºäº†ã€‚å‰4ä¸ª bitæœªåˆ†é…ï¼Œç¬¬5ä¸ªbitè¡¨ç¤ºæ˜¯å¦å‹ç¼©ï¼Œæœ€åä¸‰ä¸ªbitè¡¨ç¤ºrecord typeã€‚\n+--------------------+-------------------------------+------------------------+ | 4 bits unallocated | 1 bit snappy compression flag | 3 bit record type | +--------------------+-------------------------------+------------------------+ // Next advances the reader to the next records and returns true if it exists. // It must not be called again after it returned false. func (r *Reader) Next() bool { err := r.next() if errors.Cause(err) == io.EOF { // The last WAL segment record shouldn\u0026#39;t be torn(should be full or last).  // The last record would be torn after a crash just before  // the last record part could be persisted to disk.  if r.curRecTyp == recFirst || r.curRecTyp == recMiddle { r.err = errors.New(\u0026#34;last record is torn\u0026#34;) } return false } r.err = err return r.err == nil } func (r *Reader) next() (err error) { // We have to use r.buf since allocating byte arrays here fails escape  // analysis and ends up on the heap, even though it seemingly should not.  // å‰é¢7ä¸ªbyteä»£è¡¨headerï¼Œåé¢çš„ä¸ºdata  hdr := r.buf[:recordHeaderSize] buf := r.buf[recordHeaderSize:] r.rec = r.rec[:0] r.snappyBuf = r.snappyBuf[:0] i := 0 for { // é¦–å…ˆä»rdrä¸­è¯»å–ä¸€ä¸ªå­—èŠ‚  if _, err = io.ReadFull(r.rdr, hdr[:1]); err != nil { return errors.Wrap(err, \u0026#34;read first header byte\u0026#34;) } r.total++ // è·å–record typeï¼Œå¹¶åˆ¤æ–­æ˜¯å¦å‹ç¼©  r.curRecTyp = recTypeFromHeader(hdr[0]) compressed := hdr[0]\u0026amp;snappyMask != 0 // Gobble up zero bytes.  // å¦‚æœrecord typeä¸ºrecPageTermï¼Œä»£è¡¨åé¢pageå‰©ä½™æ•°æ®å…¨éƒ¨ä¸º0å¡«å……ã€‚å³ç¬¬ä¸€ä¸ªbyteä¸ºtypeï¼Œåé¢å…¨æ˜¯0ã€‚  if r.curRecTyp == recPageTerm { // recPageTerm is a single byte that indicates the rest of the page is padded.  // If it\u0026#39;s the first byte in a page, buf is too small and  // needs to be resized to fit pageSize-1 bytes.  buf = r.buf[1:] // We are pedantic and check whether the zeros are actually up  // to a page boundary.  // It\u0026#39;s not strictly necessary but may catch sketchy state early.  k := pageSize - (r.total % pageSize) if k == pageSize { continue // Initial 0 byte was last page byte.  } n, err := io.ReadFull(r.rdr, buf[:k]) if err != nil { return errors.Wrap(err, \u0026#34;read remaining zeros\u0026#34;) } r.total += int64(n) for _, c := range buf[:k] { if c != 0 { return errors.New(\u0026#34;unexpected non-zero byte in padded page\u0026#34;) } } continue } // è¯»å–å‰©ä½™çš„6ä¸ªbyteï¼Œåˆ†åˆ«ä»£è¡¨lengthå’Œcrc  n, err := io.ReadFull(r.rdr, hdr[1:]) if err != nil { return errors.Wrap(err, \u0026#34;read remaining header\u0026#34;) } r.total += int64(n) var ( length = binary.BigEndian.Uint16(hdr[1:]) crc = binary.BigEndian.Uint32(hdr[3:]) ) if length \u0026gt; pageSize-recordHeaderSize { return errors.Errorf(\u0026#34;invalid record size %d\u0026#34;, length) } // è¯»å–é•¿åº¦ä¸ºlengthçš„æ•°æ®ï¼Œå¹¶è®¡ç®—å…¶crcå€¼æ˜¯å¦ä¸headerä¸­çš„crcç›¸ç­‰ã€‚  n, err = io.ReadFull(r.rdr, buf[:length]) if err != nil { return err } r.total += int64(n) if n != int(length) { return errors.Errorf(\u0026#34;invalid size: expected %d, got %d\u0026#34;, length, n) } if c := crc32.Checksum(buf[:length], castagnoliTable); c != crc { return errors.Errorf(\u0026#34;unexpected checksum %x, expected %x\u0026#34;, c, crc) } // å¦‚æœä¸ºå‹ç¼©æ•°æ®ï¼Œåˆ™å°†å…¶å­˜æ”¾åœ¨snappyBufä¸­ï¼Œåé¢è¯»å–å®Œæˆåè¿›è¡Œdecodeã€‚  if compressed { r.snappyBuf = append(r.snappyBuf, buf[:length]...) } else { r.rec = append(r.rec, buf[:length]...) } if err := validateRecord(r.curRecTyp, i); err != nil { return err } if r.curRecTyp == recLast || r.curRecTyp == recFull { if compressed \u0026amp;\u0026amp; len(r.snappyBuf) \u0026gt; 0 { // The snappy library uses `len` to calculate if we need a new buffer.  // In order to allocate as few buffers as possible make the length  // equal to the capacity.  // å°†å‹ç¼©çš„æ•°æ®è¿›è¡Œè§£ç ã€‚  r.rec = r.rec[:cap(r.rec)] r.rec, err = snappy.Decode(r.rec, r.snappyBuf) return err } return nil } // Only increment i for non-zero records since we use it  // to determine valid content record sequences.  i++ } } Nextæ–¹æ³•ä»rdrä¸­è¯»å–recordï¼Œå¦‚æœå­˜åœ¨åˆ™è¿”å›trueã€‚æ¯æ¬¡æœ€å¤šè¯»å–pageSize-recordHeaderSizeå¤§å°çš„æ•°æ®ï¼Œç›´åˆ°è¯»å–å®Œæ•´çš„recordï¼Œå¦‚æœæ•°æ®è¢«å‹ç¼©ï¼Œåˆ™éœ€è¦decodeï¼Œæœ€åçš„recordå­˜å‚¨åœ¨Reader.recå­—æ®µä¸­ã€‚\né—®é¢˜ç‚¹ #   ä¸ºä»€ä¹ˆéœ€è¦recPageTermç±»å‹ï¼Œè¿™æ ·æ˜¯ä¸æ˜¯æµªè´¹äº†ä¸€æ•´ä¸ªpageå¤§å°çš„ç©ºé—´ï¼Ÿ recordä»£è¡¨ä»€ä¹ˆï¼Ÿ ä¸ºä»€ä¹ˆlengthä¸èƒ½å¤§äºpageSize-recordHeaderSizeï¼Ÿ recordçš„å¤§å°ä¼šå¤§äºsegmentå—ï¼Ÿ   References #   WAL disk format prometheus tsdbéƒ¨åˆ†æºç é˜…è¯»ä¹‹wal.LogSeries è¯¦è§£varintç¼–ç åŸç† RocksDB WAL file format  "},{"id":2,"href":"/posts/alertmanager/","title":"Alert Manager","section":"Blog","content":"AlertManager #   Architecture #     Alertmanagerä½œä¸ºä¸€ä¸ªç‹¬ç«‹çš„ç»„ä»¶ï¼Œè´Ÿè´£æ¥æ”¶å¹¶å¤„ç†æ¥è‡ªPrometheus Server(ä¹Ÿå¯ä»¥æ˜¯å…¶å®ƒçš„å®¢æˆ·ç«¯ç¨‹åº)çš„å‘Šè­¦ä¿¡æ¯ã€‚Alertmanagerå¯ä»¥å¯¹è¿™äº›å‘Šè­¦ä¿¡æ¯è¿›è¡Œè¿›ä¸€æ­¥çš„å¤„ç†ï¼Œæ¯”å¦‚å½“æ¥æ”¶åˆ°å¤§é‡é‡å¤å‘Šè­¦æ—¶èƒ½å¤Ÿæ¶ˆé™¤é‡å¤çš„å‘Šè­¦ä¿¡æ¯ï¼ŒåŒæ—¶å¯¹å‘Šè­¦ä¿¡æ¯è¿›è¡Œåˆ†ç»„å¹¶ä¸”è·¯ç”±åˆ°æ­£ç¡®çš„é€šçŸ¥æ–¹ï¼ŒPrometheuså†…ç½®äº†å¯¹é‚®ä»¶ï¼ŒSlackç­‰å¤šç§é€šçŸ¥æ–¹å¼çš„æ”¯æŒï¼ŒåŒæ—¶è¿˜æ”¯æŒä¸Webhookçš„é›†æˆï¼Œä»¥æ”¯æŒæ›´å¤šå®šåˆ¶åŒ–çš„åœºæ™¯ã€‚åŒæ—¶AlertManagerè¿˜æä¾›äº†é™é»˜å’Œå‘Šè­¦æŠ‘åˆ¶æœºåˆ¶æ¥å¯¹å‘Šè­¦é€šçŸ¥è¡Œä¸ºè¿›è¡Œä¼˜åŒ–ã€‚\n å®¢æˆ·ç«¯é€šè¿‡POSTè¯·æ±‚å‘AlertManageræ¨é€å‘Šè­¦ä¿¡æ¯ã€‚ æ¯æ¡å‘Šè­¦ä¿¡æ¯ä¸­çš„labelså¯ç”¨äºå”¯ä¸€è¯†åˆ«å‘Šè­¦ä¿¡æ¯å¹¶ç”¨äºå»é‡ã€‚    AlertManagerä¸»è¦åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œè·¯ç”±(router)å’Œæ¥æ”¶å™¨(receiver)ã€‚å‘Šè­¦æ¶ˆæ¯å…ˆè¢«ç»è¿‡è·¯ç”±æ ‘ï¼Œç„¶åè¢«åˆ†é…åˆ°å¯¹åº”çš„æ¥æ”¶å™¨ä¸­ã€‚è·¯ç”±æ ‘æ˜¯ç”±é¢„å…ˆè®¾å®šçš„è·¯ç”±è§„åˆ™ç”Ÿæˆçš„ã€‚å…¶é«˜å¯ç”¨æ¶æ„å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå…·ä½“æµç¨‹å¦‚ä¸‹ï¼š\n Prometheusä¼šé€šè¿‡è°ƒç”¨AlertManageræä¾›çš„å‘Šè­¦æ¥å£å°†åŸå§‹çš„å‘Šè­¦æ¶ˆæ¯å‘é€åˆ°AlertManagerã€‚ AlertManagerçš„APIé™¤äº†æ¥æ”¶å‘Šè­¦ï¼Œè¿˜æ¥æ”¶é™é»˜è¯·æ±‚ï¼Œå°†å…¶åˆ†åˆ«ä¿å­˜åˆ°å„è‡ªçš„provideré‡Œã€‚ provideræä¾›äº†ä¸€ä¸ªè®¢é˜…ï¼ˆsubscribeï¼‰æ¥å£ï¼Œè¿™æ ·Dispatcherç»„ä»¶ä¾¿å¯ä»¥è·å–å‘Šè­¦æ•°æ®ï¼Œå¹¶å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„ï¼Œé€šè¿‡ç”¨æˆ·é¢„å…ˆè®¾ç½®çš„è§„åˆ™è¿›å…¥å‘Šè­¦æŠ‘åˆ¶é˜¶æ®µæˆ–é™é»˜é˜¶æ®µã€‚ å¦‚æœé€šè¿‡äº†ä¸Šé¢çš„å‘Šè­¦é™é»˜é˜¶æ®µï¼Œåˆ™è¿›å…¥è·¯ç”±åˆ†å‘é˜¶æ®µï¼Œæœ€ç»ˆå‘é€é€šçŸ¥ã€‚    ä¸ŠæŠ¥æ•°æ®æ ¼å¼ #  [ { \u0026quot;labels\u0026quot;: { \u0026quot;alertname\u0026quot;: \u0026quot;\u0026lt;requiredAlertName\u0026gt;\u0026quot;, \u0026quot;\u0026lt;labelname\u0026gt;\u0026quot;: \u0026quot;\u0026lt;labelvalue\u0026gt;\u0026quot;, ... }, \u0026quot;annotations\u0026quot;: { \u0026quot;\u0026lt;labelname\u0026gt;\u0026quot;: \u0026quot;\u0026lt;labelvalue\u0026gt;\u0026quot;, }, \u0026quot;startsAt\u0026quot;: \u0026quot;\u0026lt;rfc3339\u0026gt;\u0026quot;, \u0026quot;endsAt\u0026quot;: \u0026quot;\u0026lt;rfc3339\u0026gt;\u0026quot;, \u0026quot;generatorURL\u0026quot;: \u0026quot;\u0026lt;generator_url\u0026gt;\u0026quot; }, ... ]  å…¶ä¸­ï¼š  å‘Šè­¦ä¿¡æ¯çš„Fingerprintæ˜¯é€šè¿‡labelsæ¥è¿›è¡Œè®¡ç®—çš„ã€‚ startAtå’ŒendsAtåœ¨providerçš„å‘Šè­¦åˆå¹¶ä¼šç”¨åˆ°ã€‚     Alert Provider #   Prometheusæˆ–è€…å‘Šè­¦å‘é€ç³»ç»Ÿå¯ä»¥é€šè¿‡APIçš„æ–¹å¼å‘é€ç»™Alertmanagerï¼Œæ”¶åˆ°å‘Šè­¦åå°†å‘Šè­¦åˆ†åˆ«å­˜å‚¨åœ¨Alert Providerä¸­ï¼ˆå½“å‰å®ç°æ˜¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¯ä»¥é€šè¿‡æ¥å£çš„æ–¹å¼è‡ªè¡Œå®ç°å…¶ä»–å­˜å‚¨æ–¹å¼æ¯”å¦‚MySQLæˆ–è€…ESï¼‰ã€‚ å·²è§£å†³çš„alertsä¼šå®šæœŸåœ°ä»providerä¸­æ¸…é™¤ï¼Œç”¨æˆ·å¯ä»¥å®šä¹‰ç›¸åº”çš„å›è°ƒå‡½æ•°ï¼Œåœ¨alertsè¢«åˆ é™¤æ—¶è¿›è¡Œç›¸åº”çš„å›è°ƒå¤„ç†ã€‚ Alert Provideræ”¶åˆ°å‘Šè­¦ä¿¡æ¯åå¯¹ç›¸åŒçš„æŒ‡æ ‡æ•°æ®è¿›è¡Œåˆå¹¶å¤„ç†ã€‚  // Alerts gives access to a set of alerts. All methods are goroutine-safe. type Alerts interface { // Subscribe returns an iterator over active alerts that have not been // resolved and successfully notified about. // They are not guaranteed to be in chronological order. Subscribe() AlertIterator // GetPending returns an iterator over all alerts that have // pending notifications. GetPending() AlertIterator // Get returns the alert for a given fingerprint. Get(model.Fingerprint) (*types.Alert, error) // Put adds the given alert to the set. Put(...*types.Alert) error }  Silence Provider #   Dispatcher #   Dispatcher sorts incoming alerts into aggregation groups and assigns the correct notifiers to each. AlertManagerå†…éƒ¨çš„Dispatcheré€šè¿‡è®¢é˜…çš„æ–¹å¼è·å¾—å‘Šè­¦ä¿¡æ¯æ›´æ–°ï¼ˆè·å¾—Alertsçš„è¿­ä»£å™¨ï¼Œé€šè¿‡forå¾ªç¯ä¸æ–­çš„è·å¾—å‘é€åˆ°ä¿¡é“ä¸­çš„Alerts, é€šè¿‡routeçš„matchå‡½æ•°è·å¾—åŒ¹é…çš„routeå¯¹è±¡ï¼ˆæ¯”å¦‚åŸºäºæ ‡ç­¾çš„æ­£åˆ™è¡¨è¾¾ï¼Œä¼ é€’åˆ°ä¸åŒçš„é‚®ä»¶æˆ–è€…slackä¿¡é“è·¯ç”±ï¼‰,å¹¶ä¸”æ¯éš”ä¸€æ®µæ—¶é—´å°†æ‰§è¡Œä¸€æ¬¡æ¸…ç†æ“ä½œï¼ˆå½“aggregate groupä¸­çš„å‘Šè­¦æ•°é‡ä¸ºç©ºçš„æ—¶å€™ï¼‰ï¼Œåˆ é™¤ä¹‹å‰çš„è®°å½•ã€‚æ”¶åˆ°çš„Alerté€šè¿‡æ ‡ç­¾åŒ¹é…çš„æ–¹å¼è¢«é€åˆ°ä¸åŒçš„èšåˆç»„ä¸­ç­‰å¾…Pipelineæµç¨‹è¿›è¡Œå¤„ç†ã€‚  Aggregate group #   aggrGroup aggregates alert fingerprints into groups to which a common set of routing options applies. It emits notifications in the specified intervals. èšåˆç»„aggregate groupç”¨æ¥ç®¡ç†å…·æœ‰ç›¸åŒå±æ€§ä¿¡æ¯çš„å‘Šè­¦ï¼Œé€šè¿‡å°†ç›¸åŒç±»å‹çš„å‘Šè­¦è¿›è¡Œåˆ†ç»„å¯ä»¥ç»Ÿä¸€çš„ç®¡ç†ï¼Œå› ä¸ºæœ‰æ—¶å€™å‘Šè­¦å¤„ç†æ˜¯å¤§é‡åŒæ—¶å‡ºç°çš„ï¼ˆæ¯”å¦‚ä¸€ä¸ªæ•°æ®ä¸­å¿ƒçš„å¤±æ•ˆå°†å¯¼è‡´æˆç™¾ä¸Šåƒçš„å‘Šè­¦äº§ç”Ÿï¼Œé€šè¿‡åˆ†ç»„å¯ä»¥èšåˆç›¸åŒæ ‡ç­¾åˆ°ä¸€ä¸ªé‚®ä»¶æˆ–è€…æ¥æ”¶è€…ä¸­ï¼‰ã€‚åˆ†ç»„åˆ›å»ºå°†ä¾èµ–äºå¤„ç†routeè·¯ç”±å’Œå‘Šè­¦çš„labelsæ ‡ç­¾ï¼Œä¸åŒçš„å‘Šè­¦labelså°†äº§ç”Ÿä¸åŒçš„èšåˆç»„ï¼Œæ‰€æœ‰æ¥æ”¶åˆ°çš„å‘Šè­¦å°†é¦–å…ˆè®¡ç®—ä¸€ä¸ªèšåˆç»„çš„Fingerprintå¦‚æœæ‰¾åˆ°åˆ™ç›´æ¥æ’å…¥åˆ°è¯¥ç»„ï¼Œå¦åˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„èšåˆç»„ï¼Œæ¯æ¬¡æ–°åˆ›å»ºçš„èšåˆç»„éƒ½ä¼šå¯åŠ¨ä¸€ä¸ªgoroutineæ¥æ‰§è¡Œå®é™…çš„pipeline work.   Inhibitor #   An Inhibitor determines whether a given label set is muted based on the currently active alerts and a set of inhibition rules. It implements the Muter interface. Inhibitorç”¨äºç®¡ç†ç›¸åŒçš„å‘Šè­¦é…ç½®ï¼Œ æ¯”å¦‚ä¸‹é¢çš„é…ç½®å®šä¹‰äº†å½“å‘Šè­¦åç§°alertnameä¸€è‡´çš„æ—¶å€™ï¼Œå¦‚æœä¸¥é‡å‘Šè­¦å­˜åœ¨çš„æ—¶å€™ï¼Œé€”åŒçº§åˆ«å‘Šè­¦å°†è¢«è¿‡æ»¤æ‰ã€‚ æŸ¥è¯¢æµç¨‹ä¸Šå°†è·å¾—çš„alertçš„labelè¿›è¡Œæ£€æŸ¥ï¼ŒåŒ¹é…æ£€æŸ¥çš„å†…å®¹æ»¡è¶³targetåŒ¹é…ä½†æ˜¯sourceä¸åŒ¹é…çš„æ ‡è®°ä¸ºInhibited.   Silencer #   Silencerç”¨æ¥å–æ¶ˆå‘Šè­¦ï¼Œæ¯”å¦‚ç›´æ¥é…ç½®å‘Šè­¦åœ¨æŸä¸€æ®µæ—¶é—´å†…ä¸è§¦å‘ä»»ä½•æ¶ˆæ¯ï¼Œå¯ä»¥åŸºäºæ­£åˆ™è¡¨è¾¾å¼çš„åŒ¹é…ï¼Œè¯¥é…ç½®å¯ä»¥é€šè¿‡alertmanagerçš„WebUIæˆ–è€…APIæ¥å£é…ç½®ã€‚ å½“æµç¨‹ä¼ é€’åˆ°Silenceæ­¥éª¤æ—¶å€™ï¼ŒSilenceæ¨¡å—å°†å¾ªç¯æ£€æŸ¥æ¯ä¸€ä¸ªå‘Šè­¦æ˜¯å¦æ»¡è¶³åŒ¹é…ï¼Œæ¯”å¦‚è®¾ç½®æŸä¸€ä¸ªå‘Šè­¦æ ‡ç­¾å‡ºç°åå–æ¶ˆå‘Šè­¦ã€‚å½“æŸ¥è¯¢ç»“æŸåè¿”å›ä¸€ä¸ªsilsï¼ˆSilenceçš„ç»“æ„ä½“ï¼Œç”¨æ¥æŒ‡å®šæŸä¸€ç±»å‘Šè­¦çš„Silenceåœ¨ä¸€æ®µæ—¶é—´å†…çš„å¤„ç†å¯¹è±¡ã€‚ï¼‰ä¸€ä¸ªå‘Šè­¦å¯èƒ½ä¼šè¢«å¤šä¸ªSilenceåŒæ—¶ç®¡ç†ã€‚ åŒæ—¶è¦å®ç°é›†ç¾¤ç®¡ç†ï¼Œå½¼æ­¤ä¹‹é—´çš„SilenceçŠ¶æ€ä¹Ÿè¦å…±äº«ï¼ˆå‘Šè­¦å‘é€ç»™å¤šä¸ªAMï¼‰ï¼Œå› æ­¤ç³»ç»Ÿè®¾è®¡çš„æ—¶å€™åŠ å…¥äº†SilenceProvideræ¥è¿›è¡Œé›†ç¾¤ä¹‹é—´çš„Silenceç®¡ç†,å½¼æ­¤ä¹‹é—´é€šè¿‡protoBufæ¥è¿›è¡Œæ•°æ®çŠ¶æ€çš„åŒæ­¥ã€‚åŒæ—¶é›†ç¾¤åœ¨æ¥æ”¶åˆ°å‘Šè­¦åä¹Ÿè¦è¿›è¡Œé€šçŸ¥ï¼Œå‘ŠçŸ¥å…¶ä»–çš„èŠ‚ç‚¹å…³äºå‘Šè­¦çš„å¤„ç†çŠ¶æ€ï¼Œé˜²æ­¢å¤šä¸ªé€šçŸ¥åŒæ—¶è¢«å‘é€ã€‚   Notify Provider #   Router #   Receiver Stage #  Wait #   ç­‰å¾…é—´éš”ç”¨æ¥è®¾ç½®å‘é€å‘Šè­¦çš„ç­‰å¾…æ—¶é—´ï¼Œå¯¹äºé›†ç¾¤æ“ä½œä¸­ï¼Œéœ€è¦æ ¹æ®ä¸åŒçš„peerè®¾ç½®ä¸åŒçš„è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœä»…ä»…ä¸€ä¸ªServeræœ¬èº«ï¼Œç­‰å¾…é—´éš”è®¾ç½®ä¸º0ï¼›  Dedup #   Dedup Stageç”¨äºç®¡ç†å‘Šè­¦çš„å»é‡ï¼Œä¼ é€’çš„å‚æ•°ä¸­åŒ…å«äº†ä¸€ä¸ªNotificationLog, ç”¨æ¥ä¿å­˜å‘Šè­¦çš„å‘é€è®°å½•ã€‚å½“æœ‰å¤šä¸ªæœºå™¨ç»„æˆé›†ç¾¤çš„æ—¶å€™ï¼ŒNotificationLogä¼šé€šè¿‡åè®®å»è¿›è¡Œé€šä¿¡ï¼Œä¼ é€’å½¼æ­¤çš„è®°å½•ä¿¡æ¯ï¼ŒåŠ å…¥é›†ç¾¤ä¸­çš„Aå¦‚æœå‘é€äº†å‘Šè­¦ï¼Œè¯¥è®°å½•ä¼šä¼ é€’ç»™Bæœºå™¨ï¼Œå¹¶è¿›è¡Œmergeæ“ä½œï¼Œè¿™æ ·Bæœºå™¨åœ¨å‘é€å‘Šè­¦çš„æ—¶å€™å¦‚æœæŸ¥è¯¢å·²ç»å‘é€ï¼Œåˆ™ä¸å†è¿›è¡Œå‘Šè­¦å‘é€ã€‚  Retry #   Retry Stageåˆ©ç”¨backoffç­–ç•¥æ¥ç®¡ç†å‘Šè­¦çš„é‡å‘ï¼Œå¯¹äºæ²¡æœ‰å‘é€æˆåŠŸçš„å‘Šè­¦å°†ä¸æ–­é‡è¯•ï¼Œç›´åˆ°è¶…æ—¶ã€‚  Set Notify #    Set Notifies Stageç”¨æ¥è®¾ç½®å‘é€å‘Šè­¦çš„ä¿¡æ¯åˆ°nfLogï¼Œè¯¥æ¨¡å—ä»…ä»…ç”¨äºè¢«è¯¥Alert Managerå‘é€çš„å‘Šè­¦çš„è®°å½•ï¼ˆRetryç»„ä»¶ä¼ é€’çš„alertså’ŒDedupç»„ä»¶ä¸­å‘é€å‡ºå»çš„å‘Šè­¦ä¿¡æ¯ï¼‰ã€‚\n  Integrationå®šä¹‰ä¸€ä¸ªé›†æˆè·¯ç”±ç»„ä»¶ï¼ŒåŒ…å«ç”¨æˆ·çš„é…ç½®ä¿¡æ¯å’Œåç§°ä»¥åŠå‘é€å‘Šè­¦çš„å®ç°ã€‚è‡ªå®šä¹‰çš„notifyè·¯ç”±éœ€è¦æ»¡è¶³è¯¥Notifieræ¥å£ï¼Œå®ç°Notifyæ–¹æ³•ã€‚\n   Examples #  groups: - name: httpd rules: - alert: httpd_down expr: probe_success{instance=\u0026quot;http://httpd:80\u0026quot;,job=\u0026quot;httpd\u0026quot;} == 0 for: 1m labels: severity: critical annotations: summary: \u0026quot;httpd is down\u0026quot;  Prometheus Server will wait for 1m and if the expression meets the condition for 1m, now Prometheus Server has to fire alert and forward to AlertManager. Until now, Prometheus knows how to connect to AlertManager and when to fire and forward alerts to AlertManager.  route: repeat_interval: 2h receiver: email-1 routes: - match: alertname: httpd_down receiver: email-1 - match: alertname: nginx_down receiver: email-2  These routes and receivers are defined in the AlertManager configuration file by the parent element called route. The parent route element has child routes which an alert follows in order to reach to its receiver based upon the match label as we will see in a bit.  http://localhost:9090/api/v1/alertmanagers { \u0026quot;status\u0026quot;: \u0026quot;success\u0026quot;, \u0026quot;data\u0026quot;: { \u0026quot;activeAlertmanagers\u0026quot;: [ { \u0026quot;url\u0026quot;: \u0026quot;http://127.0.0.1:9093/api/v1/alerts\u0026quot; } ], \u0026quot;droppedAlertmanagers\u0026quot;: [] } } curl -X GET http://10.255.101.73:9090/api/v1/alerts { \u0026quot;status\u0026quot;: \u0026quot;success\u0026quot;, \u0026quot;data\u0026quot;: { \u0026quot;alerts\u0026quot;: [ { \u0026quot;labels\u0026quot;: { \u0026quot;alertname\u0026quot;: \u0026quot;å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜\u0026quot;, \u0026quot;instance\u0026quot;: \u0026quot;127.0.0.1:9100\u0026quot;, \u0026quot;job\u0026quot;: \u0026quot;node\u0026quot;, \u0026quot;severity\u0026quot;: \u0026quot;warning\u0026quot; }, \u0026quot;annotations\u0026quot;: { \u0026quot;description\u0026quot;: \u0026quot;127.0.0.1:9100 of job nodeå†…å­˜ä½¿ç”¨ç‡è¶…è¿‡80%,å½“å‰ä½¿ç”¨ç‡[59.74335527485338].\u0026quot;, \u0026quot;summary\u0026quot;: \u0026quot;Instance 127.0.0.1:9100 å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜\u0026quot; }, \u0026quot;state\u0026quot;: \u0026quot;firing\u0026quot;, \u0026quot;activeAt\u0026quot;: \u0026quot;2019-08-23T11:27:34.027571952Z\u0026quot;, \u0026quot;value\u0026quot;: 59.74335527485338 } ] } } http://10.255.101.73:9093/api/v2/alerts [ { \u0026quot;annotations\u0026quot;: { \u0026quot;description\u0026quot;: \u0026quot;10.255.101.74:8051 of job default go_goroutines \u0026gt; 100,å½“å‰go_goroutines: [137].\u0026quot;, \u0026quot;summary\u0026quot;: \u0026quot;Instance 10.255.101.74:8051 go_goroutines \u0026gt; 100\u0026quot; }, \u0026quot;endsAt\u0026quot;: \u0026quot;2019-08-31T06:19:27.344Z\u0026quot;, \u0026quot;fingerprint\u0026quot;: \u0026quot;0d38358ac4713623\u0026quot;, \u0026quot;receivers\u0026quot;: [ { \u0026quot;name\u0026quot;: \u0026quot;default-receiver\u0026quot; } ], \u0026quot;startsAt\u0026quot;: \u0026quot;2019-08-23T11:28:27.344Z\u0026quot;, \u0026quot;status\u0026quot;: { \u0026quot;inhibitedBy\u0026quot;: [], \u0026quot;silencedBy\u0026quot;: [], \u0026quot;state\u0026quot;: \u0026quot;active\u0026quot; }, \u0026quot;updatedAt\u0026quot;: \u0026quot;2019-08-31T14:16:27.348+08:00\u0026quot;, \u0026quot;generatorURL\u0026quot;: \u0026quot;http://ceph-1:9090/graph?g0.expr=go_goroutines+%3E+100\u0026amp;g0.tab=1\u0026quot;, \u0026quot;labels\u0026quot;: { \u0026quot;alertname\u0026quot;: \u0026quot;go_goroutineså¤§äº100\u0026quot;, \u0026quot;instance\u0026quot;: \u0026quot;10.255.101.74:8051\u0026quot;, \u0026quot;job\u0026quot;: \u0026quot;default\u0026quot;, \u0026quot;severity\u0026quot;: \u0026quot;warning\u0026quot; } } ] http://10.255.101.73:9093/api/v1/alerts { \u0026quot;status\u0026quot;: \u0026quot;success\u0026quot;, \u0026quot;data\u0026quot;: [ { \u0026quot;labels\u0026quot;: { \u0026quot;alertname\u0026quot;: \u0026quot;go_goroutineså¤§äº100\u0026quot;, \u0026quot;instance\u0026quot;: \u0026quot;10.255.101.74:8051\u0026quot;, \u0026quot;job\u0026quot;: \u0026quot;default\u0026quot;, \u0026quot;severity\u0026quot;: \u0026quot;warning\u0026quot; }, \u0026quot;annotations\u0026quot;: { \u0026quot;description\u0026quot;: \u0026quot;10.255.101.74:8051 of job default go_goroutines \u0026gt; 100,å½“å‰go_goroutines: [135].\u0026quot;, \u0026quot;summary\u0026quot;: \u0026quot;Instance 10.255.101.74:8051 go_goroutines \u0026gt; 100\u0026quot; }, \u0026quot;startsAt\u0026quot;: \u0026quot;2019-08-23T11:28:27.344378042Z\u0026quot;, \u0026quot;endsAt\u0026quot;: \u0026quot;2019-08-31T06:21:27.344378042Z\u0026quot;, \u0026quot;generatorURL\u0026quot;: \u0026quot;http://ceph-1:9090/graph?g0.expr=go_goroutines+%3E+100\u0026amp;g0.tab=1\u0026quot;, \u0026quot;status\u0026quot;: { \u0026quot;state\u0026quot;: \u0026quot;active\u0026quot;, \u0026quot;silencedBy\u0026quot;: [], \u0026quot;inhibitedBy\u0026quot;: [] }, \u0026quot;receivers\u0026quot;: [ \u0026quot;default-receiver\u0026quot; ], \u0026quot;fingerprint\u0026quot;: \u0026quot;0d38358ac4713623\u0026quot; } ] } References #   AlertManager github SENDING ALERTS CONFIGURATION NOTIFICATION TEMPLATE REFERENCE Understanding Prometheus AlertManager Prometheusé«˜å¯ç”¨(4)ï¼šAlertmanageré«˜å¯ç”¨ Prometheus AlertManagerä»£ç é˜…è¯»ç¬”è®° Prometheus AlertManagerä»£ç é˜…è¯»ç¬”è®° Notifyç»„ä»¶ Alertsnitch Prometheus integrations Understanding and extending prometheus alertmanager Hands-On Infrastructure Monitoring with Prometheus ææ Prometheus: Alertmanager  "},{"id":3,"href":"/posts/open-falcon/","title":"Open Falcon","section":"Blog","content":"Open Faclon #   Architecture #   Faclon-agent #  Falcon-agentç”¨äºæ•°æ®çš„é‡‡é›†ï¼Œå®ƒä¼šå®šæœŸåœ°å°†metricæ•°æ®é€šè¿‡jsonRPCä¸ŠæŠ¥åˆ°Transferï¼Œå…¶ä¸ŠæŠ¥çš„metricæ•°æ®æ ¼å¼ä¸ºï¼š\nData model #  open-falconé‡‡ç”¨å’Œopentsdbç›¸åŒçš„æ•°æ®æ ¼å¼ï¼šmetricã€endpointåŠ å¤šç»„key value tagsã€‚ä¾‹å¦‚ï¼š\n{ metric: load.1min, endpoint: open-falcon-host, tags: srv=falcon,idc=aws-sgp,group=az1, value: 1.5, timestamp: `date +%s`, counterType: GAUGE, step: 60 }  Transfer #   Transferæ¥æ”¶åˆ°agentä¸ŠæŠ¥çš„metricæ•°æ®åï¼Œç»è¿‡ä¸€å®šçš„å¤„ç†ï¼ˆå°†tagså­—ç¬¦ä¸²è½¬åŒ–ä¸ºmapï¼‰ï¼Œç„¶åä¸ŠæŠ¥åˆ°Graph, Judgeå’ŒTSDBã€‚  æä¾›æ•°æ®æ¥æ”¶æ¥å£ä¾›Agentå’Œè‡ªå®šä¹‰è„šæœ¬pushç›‘æ§æ•°æ®ã€‚ å¯¹æ¥æ”¶åˆ°çš„æ•°æ®åšåˆæ³•æ€§æ ¡éªŒï¼Œè§„æ•´ã€‚ é’ˆå¯¹æ¯ä¸ªåç«¯å®ä¾‹ç»´æŠ¤ä¸€ä¸ªRPCè¿æ¥æ± ã€‚ å‡†å¤‡å†…å­˜Queueä¸­è½¬ç›‘æ§æ•°æ®ã€‚ æ ¹æ®ä¸€è‡´æ€§å“ˆå¸Œå°†Queueä¸­çš„æ•°æ®è½¬å‘ç»™Judgeå’ŒGraphã€‚ å½“åç«¯å®•æœºçš„æ—¶å€™åšå°‘é‡æ•°æ®ç¼“å­˜ï¼Œæä¾›é‡è¯•æœºåˆ¶ã€‚     Heartbeat Server #   HBSä¸»è¦æœ‰å¦‚ä¸‹åŠŸèƒ½ï¼š  agentå‘é€å¿ƒè·³ä¿¡æ¯ç»™HBSçš„æ—¶å€™ï¼Œä¼šæŠŠhostnameã€ipã€agent versionã€plugin versionç­‰ä¿¡æ¯å‘Šè¯‰HBSï¼ŒHBSè´Ÿè´£æ›´æ–°hostè¡¨ã€‚ å°†IPç™½åå•åˆ†å‘åˆ°æ‰€æœ‰çš„agentã€‚ å‘Šè¯‰å„ä¸ªagentåº”è¯¥æ‰§è¡Œå“ªäº›æ’ä»¶ã€‚ å‘Šè¯‰å„ä¸ªagentåº”è¯¥ç›‘å¬å“ªäº›ç«¯å£ï¼Œè¿›ç¨‹ã€‚ ç¼“å­˜ç›‘æ§ç­–ç•¥ã€‚  HBSå»è·å–æ‰€æœ‰çš„æŠ¥è­¦ç­–ç•¥ç¼“å­˜åœ¨å†…å­˜é‡Œï¼Œç„¶åJudgeå»å‘HBSè¯·æ±‚ã€‚å…¶ä¸­Judgeé€šè¿‡rpcè°ƒç”¨æ¥è·å–ã€‚  åœ¨é…ç½®æŠ¥è­¦ç­–ç•¥çš„æ—¶å€™é…ç½®äº†æŠ¥è­¦çº§åˆ«ï¼Œæ¯”å¦‚P0/P1/P2ç­‰ç­‰ï¼Œæ¯ä¸ªçº§åˆ«çš„æŠ¥è­¦éƒ½ä¼šå¯¹åº”ä¸åŒçš„redisé˜Ÿåˆ—ã€‚         Judge #   å› ä¸ºç›‘æ§ç³»ç»Ÿæ•°æ®é‡æ¯”è¾ƒå¤§ï¼Œä¸€å°æœºå™¨æ˜¾ç„¶æ˜¯æä¸å®šçš„ï¼Œæ‰€ä»¥å¿…é¡»è¦æœ‰ä¸ªæ•°æ®åˆ†ç‰‡æ–¹æ¡ˆã€‚Transferé€šè¿‡ä¸€è‡´æ€§å“ˆå¸Œæ¥åˆ†ç‰‡ï¼Œæ¯ä¸ªJudgeå°±åªéœ€è¦å¤„ç†ä¸€å°éƒ¨åˆ†æ•°æ®å°±å¯ä»¥äº†ã€‚ åŒæ—¶Judgeä¼šå®šæœŸåœ°é€šè¿‡RPCä»Heartbeat ServeråŒæ­¥Strategyå’ŒExpressionç”¨äºå‘Šè­¦çš„åˆ¤å®šã€‚ Judgeæ¥æ”¶åˆ°Transferçš„metricæ•°æ®åé¦–å…ˆæ˜¯å¦æœ‰é’ˆå¯¹å…¶çš„Strategyå’ŒExpressionï¼Œå¦‚æœæ²¡æœ‰åˆ™ç›´æ¥è·³è¿‡ï¼Œå¦‚æœæœ‰åˆ™è¿›è¡Œå‘Šè­¦åˆ¤å®šã€‚ Judgeä¼šå°†åˆ¤å®šç»“æœä»¥Eventçš„å½¢å¼å‘é€åˆ°Redisç¼“å­˜ä¸­ã€‚   Alarm #   Alarmä»redisç¼“å­˜ä¸­è·å–Judgeæ¨é€çš„Eventåï¼Œæ ¹æ®Eventçš„ä¼˜å…ˆçº§åˆ†åˆ«è¿›è¡Œå¤„ç†ã€‚ Alarmä»redisé˜Ÿåˆ—åˆ†åˆ«è·å–é«˜ä¼˜å…ˆçº§çš„Eventå’Œä½ä¼˜å…ˆçº§çš„Eventï¼Œå…¶åˆ†åˆ«ä½äºhighQueueså’ŒlowQueuesï¼Œå…¶ä¸­highQueuesä¸­é…ç½®çš„å‡ ä¸ªeventé˜Ÿåˆ—ä¸­çš„äº‹ä»¶æ˜¯ä¸ä¼šåšå‘Šè­¦åˆå¹¶çš„ï¼ŒlowQueuesä¼šåšå‘Šè­¦åˆå¹¶ã€‚  æŒ‰ç…§ä¼˜å…ˆçº§è½®è¯¢Redisè¯»å–å‘Šè­¦äº‹ä»¶ã€‚ å¯¹éœ€è¦å›è°ƒçš„å‘Šè­¦äº‹ä»¶å›è°ƒä¸šåŠ¡ç³»ç»Ÿæ¥å£ã€‚ å¯¹é«˜ä¼˜å…ˆçº§å‘Šè­¦äº‹ä»¶ç›´æ¥ç”Ÿæˆå‘Šè­¦é‚®ä»¶å’ŒçŸ­ä¿¡ã€‚ å¯¹ä½ä¼˜å…ˆçº§å‘Šè­¦äº‹ä»¶åšåˆå¹¶ã€‚ æä¾›webé¡µé¢å±•ç¤ºå½“å‰æœªæ¢å¤çš„å‘Šè­¦ã€‚   åˆ¶å®šé‚®ä»¶ï¼ŒçŸ­ä¿¡å‘é€çš„æ¥å£è§„èŒƒã€‚   Nodata #   nodataç”¨äºæ£€æµ‹ç›‘æ§æ•°æ®çš„ä¸ŠæŠ¥å¼‚å¸¸ã€‚nodataå’Œå®æ—¶æŠ¥è­¦judgeæ¨¡å—ååŒå·¥ä½œï¼Œè¿‡ç¨‹ä¸º: é…ç½®äº†nodataçš„é‡‡é›†é¡¹è¶…æ—¶æœªä¸ŠæŠ¥æ•°æ®ï¼Œnodataç”Ÿæˆä¸€æ¡é»˜è®¤çš„æ¨¡æ‹Ÿæ•°æ®ï¼›ç”¨æˆ·é…ç½®ç›¸åº”çš„æŠ¥è­¦ç­–ç•¥ï¼Œæ”¶åˆ°mockæ•°æ®å°±äº§ç”ŸæŠ¥è­¦ã€‚é‡‡é›†é¡¹ä¸ŠæŠ¥å¼‚å¸¸æ£€æµ‹ï¼Œä½œä¸ºjudgeæ¨¡å—çš„ä¸€ä¸ªå¿…è¦è¡¥å……ï¼Œèƒ½å¤Ÿä½¿judgeçš„å®æ—¶æŠ¥è­¦åŠŸèƒ½æ›´åŠ å¯é ã€å®Œå–„ã€‚    Graph #   References #   Open-falcon falcon-plus Falcon+ API Nodata æ–‡æ¡£ å¿ƒè·³æœåŠ¡å™¨ Falcon-HBS æºç è§£è¯»è§†é¢‘ open-falcon 2.0æ–‡æ¡£ open-falconéƒ¨ç½²ä¸æ¶æ„è§£æ æ•°æ®é‡‡é›†æ¨¡å— Falcon-Agent æºç è§£è¯» è¿ç»´ç›‘æ§è§†é¢‘  "}]